<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Portal ‚Äî Rena Rehabilitation Centre</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --navy-900: #050d1a;
  --navy-800: #0a1628;
  --navy-700: #0d1f3c;
  --blue-500: #1a56db;
  --blue-400: #3b82f6;
  --blue-300: #60a5fa;
  --blue-200: #93c5fd;
  --blue-100: #dbeafe;
  --accent: #0ea5e9;
  --accent-glow: rgba(14,165,233,0.3);
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --text-primary: #f0f6ff;
  --text-secondary: #94b8d8;
  --text-muted: #5a7fa8;
  --card-bg: rgba(13,31,60,0.7);
  --card-border: rgba(59,130,246,0.15);
  --sidebar-w: 250px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--navy-900);
  color: var(--text-primary);
  min-height: 100vh;
}
body::before {
  content:'';
  position:fixed;
  inset:0;
  background:
    radial-gradient(ellipse 80% 50% at 20% 10%, rgba(26,86,219,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(14,165,233,0.08) 0%, transparent 50%);
  pointer-events:none;
  z-index:0;
}

/* SIDEBAR */
.sidebar {
  position:fixed; top:0; left:0;
  width:var(--sidebar-w);
  height:100vh;
  background:linear-gradient(180deg, var(--navy-800) 0%, var(--navy-900) 100%);
  border-right:1px solid var(--card-border);
  display:flex; flex-direction:column;
  z-index:100;
}
.brand {
  padding:24px 20px 18px;
  border-bottom:1px solid var(--card-border);
}
.brand-logo {
  width:42px; height:42px;
  background:linear-gradient(135deg, var(--blue-500), var(--accent));
  border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-size:22px;
  margin-bottom:10px;
  box-shadow:0 4px 16px var(--accent-glow);
}
.brand-name {
  font-family:'Sora',sans-serif;
  font-size:13px; font-weight:600;
  color:var(--text-primary); line-height:1.3;
}
.brand-sub { font-size:11px; color:var(--text-muted); margin-top:2px; }

.patient-info {
  padding:14px 16px;
  margin:12px 8px;
  background:rgba(26,86,219,0.1);
  border:1px solid var(--card-border);
  border-radius:10px;
}
.pt-avatar {
  width:38px; height:38px;
  background:linear-gradient(135deg, #1e3a5f, var(--blue-500));
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:18px;
  margin-bottom:8px;
}
.pt-name { font-family:'Sora',sans-serif; font-size:13px; font-weight:600; }
.pt-id { font-size:11px; color:var(--text-muted); font-family:'DM Mono',monospace; margin-top:2px; }
.reg-badge {
  display:inline-flex; align-items:center; gap:4px;
  font-size:10px; padding:2px 7px;
  border-radius:20px;
  margin-top:6px;
}
.reg-active { background:rgba(16,185,129,0.15); color:var(--success); border:1px solid rgba(16,185,129,0.3); }
.reg-pending { background:rgba(245,158,11,0.15); color:var(--warning); border:1px solid rgba(245,158,11,0.3); }

.nav-section { padding:8px 12px 4px; font-size:10px; font-weight:600; letter-spacing:.1em; text-transform:uppercase; color:var(--text-muted); }
.nav-item {
  display:flex; align-items:center; gap:10px;
  padding:9px 16px 9px 20px;
  margin:1px 8px;
  border-radius:8px;
  cursor:pointer;
  font-size:13.5px;
  color:var(--text-secondary);
  transition:all .18s ease;
}
.nav-item:hover { background:rgba(59,130,246,.1); color:var(--text-primary); }
.nav-item.active { background:rgba(26,86,219,.2); color:var(--blue-300); border-left:2px solid var(--blue-400); }
.nav-item .icon { font-size:16px; width:20px; text-align:center; }
.sidebar-footer { margin-top:auto; padding:12px 8px; border-top:1px solid var(--card-border); }

/* MAIN */
.main { margin-left:var(--sidebar-w); min-height:100vh; position:relative; z-index:1; }
.topbar {
  position:sticky; top:0;
  background:rgba(5,13,26,.92);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--card-border);
  padding:0 28px; height:60px;
  display:flex; align-items:center; justify-content:space-between;
  z-index:90;
}
.page-title { font-family:'Sora',sans-serif; font-size:17px; font-weight:600; }
.content { padding:24px 28px; }
.section { display:none; }
.section.active { display:block; animation:fadeIn .3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

/* BUTTONS */
.btn {
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 16px; border-radius:8px;
  font-size:13px; font-weight:500;
  cursor:pointer; border:none;
  transition:all .18s ease;
  font-family:'DM Sans',sans-serif;
  text-decoration:none;
}
.btn-primary { background:var(--blue-500); color:white; }
.btn-primary:hover { background:var(--blue-400); transform:translateY(-1px); }
.btn-secondary { background:rgba(26,86,219,.15); color:var(--blue-300); border:1px solid rgba(26,86,219,.3); }
.btn-secondary:hover { background:rgba(26,86,219,.25); }
.btn-ghost { background:transparent; color:var(--text-secondary); border:1px solid var(--card-border); }
.btn-ghost:hover { background:rgba(59,130,246,.1); color:var(--text-primary); }
.btn-success { background:rgba(16,185,129,.2); color:var(--success); border:1px solid rgba(16,185,129,.3); }
.btn-danger { background:rgba(239,68,68,.12); color:var(--danger); border:1px solid rgba(239,68,68,.25); }

/* CARDS */
.card {
  background:var(--card-bg);
  border:1px solid var(--card-border);
  border-radius:14px;
  backdrop-filter:blur(10px);
  overflow:hidden;
  margin-bottom:16px;
}
.card-header {
  padding:16px 20px;
  border-bottom:1px solid var(--card-border);
  display:flex; align-items:center; justify-content:space-between;
}
.card-title { font-family:'Sora',sans-serif; font-size:14px; font-weight:600; }
.card-body { padding:20px; }

/* STATS */
.stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:22px; }
.stat-card {
  background:var(--card-bg);
  border:1px solid var(--card-border);
  border-radius:14px;
  padding:18px 20px;
  position:relative;
  overflow:hidden;
  backdrop-filter:blur(10px);
  transition:transform .2s, box-shadow .2s;
}
.stat-card:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(26,86,219,.15); }
.stat-card::before {
  content:'';
  position:absolute; top:0; left:0; right:0;
  height:2px;
  background:linear-gradient(90deg, var(--blue-500), var(--accent));
  opacity:.6;
}
.stat-icon { font-size:22px; margin-bottom:10px; }
.stat-value { font-family:'Sora',sans-serif; font-size:26px; font-weight:700; line-height:1; }
.stat-label { font-size:12px; color:var(--text-muted); margin-top:4px; }

/* TABLE */
.data-table { width:100%; border-collapse:collapse; }
.data-table th {
  padding:10px 16px;
  text-align:left;
  font-size:11px; font-weight:600;
  letter-spacing:.06em; text-transform:uppercase;
  color:var(--text-muted);
  background:rgba(26,86,219,.06);
  border-bottom:1px solid var(--card-border);
}
.data-table td {
  padding:12px 16px;
  font-size:13px; color:var(--text-secondary);
  border-bottom:1px solid rgba(59,130,246,.06);
}
.data-table tr:last-child td { border-bottom:none; }
.data-table tr:hover td { background:rgba(59,130,246,.04); }
.data-table .primary { color:var(--text-primary); font-weight:500; }

/* STATUS */
.pill {
  display:inline-block; padding:3px 9px;
  border-radius:20px; font-size:11px; font-weight:500;
}
.pill-green { background:rgba(16,185,129,.15); color:var(--success); }
.pill-blue { background:rgba(59,130,246,.15); color:var(--blue-300); }
.pill-yellow { background:rgba(245,158,11,.15); color:var(--warning); }
.pill-red { background:rgba(239,68,68,.15); color:var(--danger); }

/* MODAL */
.modal-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(5,13,26,.88);
  backdrop-filter:blur(6px);
  z-index:200;
  align-items:center; justify-content:center;
}
.modal-overlay.open { display:flex; }
.modal {
  background:var(--navy-700);
  border:1px solid var(--card-border);
  border-radius:18px;
  width:640px; max-width:95vw;
  max-height:88vh; overflow-y:auto;
}
.modal-header {
  padding:20px 24px;
  border-bottom:1px solid var(--card-border);
  display:flex; align-items:center; justify-content:space-between;
}
.modal-title { font-family:'Sora',sans-serif; font-size:16px; font-weight:600; }
.modal-close { background:none; border:none; color:var(--text-muted); font-size:20px; cursor:pointer; padding:2px 8px; border-radius:6px; }
.modal-close:hover { background:rgba(239,68,68,.15); color:var(--danger); }
.modal-body { padding:24px; }

/* FORMS */
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.form-group { display:flex; flex-direction:column; gap:5px; }
.form-group.full { grid-column:1/-1; }
.form-label { font-size:11px; font-weight:600; letter-spacing:.05em; text-transform:uppercase; color:var(--text-muted); }
.form-input, .form-select {
  background:rgba(26,86,219,.06);
  border:1px solid var(--card-border);
  border-radius:8px; padding:9px 12px;
  color:var(--text-primary); font-size:13px;
  font-family:'DM Sans',sans-serif;
  outline:none; width:100%;
  transition:border-color .15s;
}
.form-input:focus, .form-select:focus { border-color:var(--blue-400); background:rgba(26,86,219,.1); }
.form-select option { background:var(--navy-700); }

/* STEPS */
.steps {
  display:flex; align-items:center; gap:8px;
  margin-bottom:24px;
}
.step {
  display:flex; align-items:center; gap:6px;
  font-size:12px; color:var(--text-muted);
}
.step.active { color:var(--blue-300); }
.step.done { color:var(--success); }
.step-num {
  width:22px; height:22px;
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:11px; font-weight:700;
  background:rgba(59,130,246,.1);
  border:1px solid var(--card-border);
  flex-shrink:0;
}
.step.active .step-num { background:var(--blue-500); border-color:var(--blue-400); color:white; }
.step.done .step-num { background:var(--success); border-color:var(--success); color:white; }
.step-sep { width:24px; height:1px; background:var(--card-border); flex-shrink:0; }

/* SLOT GRID */
.slot-grid {
  display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
  margin:12px 0;
}
.slot {
  padding:8px; text-align:center;
  background:rgba(26,86,219,.08);
  border:1px solid var(--card-border);
  border-radius:8px;
  font-size:12px; font-family:'DM Mono',monospace;
  cursor:pointer; transition:all .15s;
}
.slot:hover { border-color:var(--blue-400); background:rgba(26,86,219,.2); color:var(--blue-200); }
.slot.selected { background:var(--blue-500); border-color:var(--blue-400); color:white; }
.slot.booked { opacity:.35; cursor:not-allowed; }

/* INVOICE CARD */
.invoice-card {
  border:1px solid var(--card-border);
  border-radius:10px;
  overflow:hidden;
  margin-bottom:10px;
  transition:all .2s;
}
.invoice-card:hover { border-color:var(--blue-400); }
.invoice-header {
  padding:12px 16px;
  background:rgba(26,86,219,.08);
  display:flex; justify-content:space-between; align-items:center;
}
.invoice-body { padding:12px 16px; }

/* LOADING */
.loading { display:flex; align-items:center; justify-content:center; padding:36px; color:var(--text-muted); font-size:13px; gap:8px; }
.spinner { width:16px; height:16px; border:2px solid var(--card-border); border-top-color:var(--blue-400); border-radius:50%; animation:spin .8s linear infinite; }
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state { text-align:center; padding:40px 20px; color:var(--text-muted); }
.empty-state .icon { font-size:36px; margin-bottom:10px; opacity:.5; }
.empty-state p { font-size:13px; }
.alert { padding:10px 14px; border-radius:8px; font-size:12px; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.alert-info { background:rgba(14,165,233,.12); border:1px solid rgba(14,165,233,.25); color:var(--accent); }
.alert-success { background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.25); color:var(--success); }
.alert-error { background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.25); color:var(--danger); }
.alert-warn { background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.25); color:var(--warning); }

/* DEPT GRID */
.dept-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
.dept-card {
  padding:14px;
  background:rgba(26,86,219,.06);
  border:1px solid var(--card-border);
  border-radius:10px;
  cursor:pointer; text-align:center;
  transition:all .2s;
}
.dept-card:hover, .dept-card.selected { background:rgba(26,86,219,.2); border-color:var(--blue-400); }
.dept-card .dept-icon { font-size:24px; margin-bottom:6px; }
.dept-card .dept-name { font-size:12px; font-weight:500; }

/* PRAC CARDS */
.prac-cards { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.prac-card {
  padding:14px;
  background:rgba(26,86,219,.06);
  border:1px solid var(--card-border);
  border-radius:10px;
  cursor:pointer;
  transition:all .2s;
  display:flex; align-items:center; gap:10px;
}
.prac-card:hover, .prac-card.selected { background:rgba(26,86,219,.2); border-color:var(--blue-400); }
.prac-avatar { width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg, #1e3a5f, var(--blue-500)); display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
.prac-name { font-size:13px; font-weight:500; }
.prac-dept { font-size:11px; color:var(--text-muted); margin-top:2px; }

::-webkit-scrollbar{width:6px} ::-webkit-scrollbar-track{background:transparent} ::-webkit-scrollbar-thumb{background:#1e3a5f; border-radius:3px}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="brand">
    <div class="brand-logo">üè•</div>
    <div class="brand-name">Rena Rehabilitation</div>
    <div class="brand-sub">Patient Portal</div>
  </div>

  <div class="patient-info" id="patientInfoBox">
    <div class="pt-avatar">üë§</div>
    <div class="pt-name" id="ptName">Loading...</div>
    <div class="pt-id" id="ptId">‚Äî</div>
    <span class="reg-badge reg-pending" id="regBadge">‚è≥ Checking status...</span>
  </div>

  <div class="nav-section">Menu</div>
  <div class="nav-item active" onclick="showSection('dashboard')"><span class="icon">üìä</span> Dashboard</div>
  <div class="nav-item" onclick="showSection('bookAppt')"><span class="icon">üìÖ</span> Book Appointment</div>
  <div class="nav-item" onclick="showSection('myAppts')"><span class="icon">üóì</span> My Appointments</div>
  <div class="nav-item" onclick="showSection('myBills')"><span class="icon">üí≥</span> My Bills</div>
  <div class="nav-item" onclick="showSection('myHistory')"><span class="icon">üìã</span> Medical History</div>

  <div class="sidebar-footer">
    <div class="nav-item" onclick="logout()" style="color:var(--danger)"><span class="icon">üö™</span> Logout</div>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div class="page-title" id="pageTitle">Dashboard</div>
    <div style="display:flex;gap:10px;align-items:center;">
      <div id="topbarMsg"></div>
      <button class="btn btn-primary" onclick="showSection('bookAppt')">+ Book Appointment</button>
    </div>
  </div>

  <div class="content">

    <!-- REGISTRATION GATE -->
    <div id="regGate" style="display:none;" class="card" style="margin-bottom:20px;">
      <div class="card-body" style="text-align:center; padding:32px;">
        <div style="font-size:40px; margin-bottom:12px;">üè•</div>
        <div style="font-family:'Sora',sans-serif; font-size:18px; font-weight:600; margin-bottom:8px;">Complete Registration</div>
        <div style="font-size:13px; color:var(--text-muted); margin-bottom:20px;">Pay the one-time registration fee to activate your patient account.</div>
        <div style="font-family:'Sora',sans-serif; font-size:28px; font-weight:700; color:var(--blue-300); margin-bottom:20px;" id="regFeeAmt">‚Çπ ‚Äî</div>
        <button class="btn btn-primary" onclick="payRegistrationFee()">Pay Registration Fee</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="s_dashboard" class="section active">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-value" id="statUpcoming">‚Äî</div><div class="stat-label">Upcoming Appointments</div></div>
        <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="statVisits">‚Äî</div><div class="stat-label">Total Visits</div></div>
        <div class="stat-card"><div class="stat-icon">üí≥</div><div class="stat-value" id="statPending">‚Äî</div><div class="stat-label">Pending Bills</div></div>
        <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-value" id="statRecords">‚Äî</div><div class="stat-label">Medical Records</div></div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
        <div class="card">
          <div class="card-header"><span class="card-title">üìÖ Upcoming Appointments</span></div>
          <div id="dashAppts"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">üí≥ Recent Bills</span><button class="btn btn-ghost" style="font-size:12px;" onclick="showSection('myBills')">View All</button></div>
          <div id="dashBills"><div class="loading"><div class="spinner"></div></div></div>
        </div>
      </div>
    </div>

    <!-- BOOK APPOINTMENT -->
    <div id="s_bookAppt" class="section">
      <div class="card">
        <div class="card-header"><span class="card-title">üìÖ Book New Appointment</span></div>
        <div class="card-body">
          <div class="steps" id="bookingSteps">
            <div class="step active" id="stepEl1"><div class="step-num">1</div> Department</div>
            <div class="step-sep"></div>
            <div class="step" id="stepEl2"><div class="step-num">2</div> Doctor</div>
            <div class="step-sep"></div>
            <div class="step" id="stepEl3"><div class="step-num">3</div> Date & Slot</div>
            <div class="step-sep"></div>
            <div class="step" id="stepEl4"><div class="step-num">4</div> Confirm</div>
          </div>

          <div id="bookingAlert"></div>

          <!-- STEP 1: DEPARTMENT -->
          <div id="bStep1">
            <div style="margin-bottom:12px; font-size:13px; color:var(--text-muted);">Select your department</div>
            <div class="dept-grid" id="deptGrid"><div class="loading"><div class="spinner"></div></div></div>
          </div>

          <!-- STEP 2: DOCTOR -->
          <div id="bStep2" style="display:none;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:14px;">
              <button class="btn btn-ghost" style="font-size:12px;" onclick="gotoBookStep(1)">‚Üê Back</button>
              <span style="font-size:13px; color:var(--text-muted);">Select a practitioner</span>
            </div>
            <div class="prac-cards" id="pracGrid"><div class="loading"><div class="spinner"></div></div></div>
          </div>

          <!-- STEP 3: DATE & SLOT -->
          <div id="bStep3" style="display:none;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
              <button class="btn btn-ghost" style="font-size:12px;" onclick="gotoBookStep(2)">‚Üê Back</button>
              <span style="font-size:13px; color:var(--text-muted);">Choose date and time</span>
            </div>
            <div style="display:grid; grid-template-columns:200px 1fr; gap:20px;">
              <div>
                <div class="form-group">
                  <label class="form-label">Appointment Date</label>
                  <input type="date" class="form-input" id="apptDate" onchange="loadSlots()">
                </div>
                <div class="form-group" style="margin-top:10px;">
                  <label class="form-label">Appointment Type</label>
                  <select class="form-select" id="apptType">
                    <option value="New Patient">New Patient</option>
                    <option value="Follow Up">Follow Up</option>
                    <option value="Emergency">Emergency</option>
                  </select>
                </div>
              </div>
              <div>
                <div class="form-label" style="margin-bottom:8px;">Available Slots</div>
                <div class="slot-grid" id="slotGrid"><div style="color:var(--text-muted);font-size:13px;">Select a date first</div></div>
              </div>
            </div>
            <div style="margin-top:16px; text-align:right;">
              <button class="btn btn-primary" onclick="gotoBookStep(4)" id="slotNextBtn" disabled>Continue ‚Üí</button>
            </div>
          </div>

          <!-- STEP 4: CONFIRM -->
          <div id="bStep4" style="display:none;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
              <button class="btn btn-ghost" style="font-size:12px;" onclick="gotoBookStep(3)">‚Üê Back</button>
              <span style="font-size:13px; color:var(--text-muted);">Confirm your appointment</span>
            </div>
            <div class="card" style="background:rgba(26,86,219,.08);">
              <div class="card-body">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;" id="confirmDetails"></div>
              </div>
            </div>
            <div style="margin-top:16px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
              <button class="btn btn-ghost" onclick="gotoBookStep(3)">Change</button>
              <button class="btn btn-primary" id="confirmBookBtn" onclick="confirmBooking()">‚úì Confirm Booking</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MY APPOINTMENTS -->
    <div id="s_myAppts" class="section">
      <div class="card">
        <div class="card-header"><span class="card-title">üóì My Appointments</span></div>
        <div class="card-body" style="padding:0;">
          <table class="data-table">
            <thead><tr><th>Date</th><th>Time</th><th>Doctor</th><th>Department</th><th>Type</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="apptsTbody"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MY BILLS -->
    <div id="s_myBills" class="section">
      <div class="card">
        <div class="card-header"><span class="card-title">üí≥ My Bills & Invoices</span></div>
        <div class="card-body" style="padding:0;">
          <table class="data-table">
            <thead><tr><th>Invoice</th><th>Date</th><th>Amount</th><th>Outstanding</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="billsTbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MEDICAL HISTORY -->
    <div id="s_myHistory" class="section">
      <div class="card">
        <div class="card-header"><span class="card-title">üìã Medical History</span></div>
        <div class="card-body">
          <div id="historyContent"><div class="loading"><div class="spinner"></div></div></div>
        </div>
      </div>
    </div>

  </div>
</main>

<!-- PAYMENT MODAL -->
<div class="modal-overlay" id="payModal">
  <div class="modal" style="width:480px;">
    <div class="modal-header">
      <div class="modal-title">Pay Registration Fee</div>
      <button class="modal-close" onclick="closeModal('payModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="payAlertArea"></div>
      <div style="text-align:center; padding:20px 0;">
        <div style="font-size:36px; margin-bottom:8px;">üí≥</div>
        <div style="font-family:'Sora',sans-serif; font-size:28px; font-weight:700; color:var(--blue-300);" id="modalFeeAmt">‚Çπ ‚Äî</div>
        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">One-time registration fee</div>
      </div>
      <div class="form-group" style="margin-bottom:16px;">
        <label class="form-label">Payment Mode</label>
        <select class="form-select" id="payMode">
          <option value="Cash">Cash</option>
          <option value="Card">Card</option>
          <option value="UPI">UPI</option>
          <option value="Cheque">Cheque</option>
        </select>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn btn-ghost" onclick="closeModal('payModal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitRegPayment()">Pay Now</button>
      </div>
    </div>
  </div>
</div>

<script>
const BASE = '';

// Get CSRF token from frappe global or cookie
function getCsrf() {
  if (typeof frappe !== 'undefined' && frappe.csrf_token) return frappe.csrf_token;
  return (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';
}

// Call a Server Script API method (short name, no module prefix needed)
async function api(method, args={}) {
  const res = await fetch(`${BASE}/api/method/${method}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Frappe-CSRF-Token': getCsrf()
    },
    body: JSON.stringify(args)
  });
  if (res.status === 403) { window.location.href = '/login'; return null; }
  const data = await res.json();
  if (data.exc) throw new Error(data._server_messages || data.exc);
  return data.message ?? data;
}

// Frappe method call (built-in methods)
async function frappe_call(method, args={}) {
  const res = await fetch(`${BASE}/api/method/${method}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Frappe-CSRF-Token': getCsrf()
    },
    body: JSON.stringify(args)
  });
  const data = await res.json();
  if (data.exc) throw new Error(data.exc);
  return data.message ?? data;
}

async function getList(doctype, fields=['name'], filters=[], limit=50, orderBy='modified desc') {
  const params = new URLSearchParams({
    doctype,
    fields: JSON.stringify(fields),
    filters: JSON.stringify(filters),
    limit_page_length: limit,
    order_by: orderBy
  });
  const res = await fetch(`${BASE}/api/resource/${encodeURIComponent(doctype)}?${params}`, {
    headers: { 'X-Frappe-CSRF-Token': getCsrf() }
  });
  if (res.status === 403) { window.location.href = '/login'; return []; }
  const d = await res.json();
  return d.data || [];
}

let patientDoc = null;
let isRegistered = false;
let booking = { dept: null, prac: null, pracName: null, deptName: null, date: null, slot: null, type: null };

async function init() {
  // Step 1: Check if user is logged in via whoami
  let currentUser = null;
  try {
    const res = await fetch(`${BASE}/api/method/frappe.auth.get_logged_user`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Frappe-CSRF-Token': getCsrf() },
      body: JSON.stringify({})
    });
    const d = await res.json();
    currentUser = d.message || null;
  } catch(e) {}

  if (!currentUser || currentUser === 'Guest') {
    window.location.replace('/login');
    return;
  }

  // Step 2: Get patient profile (links email ‚Üí Patient record)
  try {
    const prof = await api('patient_profile');
    if (prof && prof.patient) {
      patientDoc = { name: prof.patient, patient_name: prof.patient_name, ...prof };
      document.getElementById('ptName').textContent = prof.patient_name || currentUser;
      document.getElementById('ptId').textContent = prof.patient || '';

      // Step 3: Check registration status
      try {
        const status = await api('patient_portal_status');
        isRegistered = !!(status && status.paid);
      } catch(e) {
        // If status check fails, assume registered (Active patient)
        isRegistered = (prof.status === 'Active');
      }

      const badge = document.getElementById('regBadge');
      if (isRegistered) {
        badge.textContent = '‚úì Active Patient';
        badge.className = 'reg-badge reg-active';
      } else {
        badge.textContent = '‚è≥ Registration Pending';
        badge.className = 'reg-badge reg-pending';
        try {
          const feeResp = await api('get_registration_fee');
          showRegGate(feeResp?.fee || 0);
        } catch(e) { showRegGate(0); }
      }
    } else {
      // Logged in but not linked to any Patient record
      document.getElementById('ptName').textContent = currentUser;
      document.getElementById('ptId').textContent = 'No patient record';
      document.getElementById('regBadge').textContent = '‚ö† Not Linked';
      document.getElementById('regBadge').className = 'reg-badge reg-pending';
      document.getElementById('topbarMsg').innerHTML =
        `<span style="font-size:12px;color:var(--warning)">‚ö† Your account (${currentUser}) is not linked to a Patient record. Contact the front desk.</span>`;
    }
  } catch(e) {
    console.error('Portal init error:', e);
    document.getElementById('ptName').textContent = currentUser;
    document.getElementById('topbarMsg').innerHTML =
      `<span style="font-size:12px;color:var(--danger)">‚ö† Error loading patient data: ${e.message}</span>`;
  }

  loadDashboard();
  setDefaultDate();
}

function showRegGate(fee) {
  document.getElementById('regGate').style.display = 'block';
  document.getElementById('regFeeAmt').textContent = `‚Çπ ${fee}`;
  document.getElementById('modalFeeAmt').textContent = `‚Çπ ${fee}`;
}

function setDefaultDate() {
  const d = new Date();
  d.setDate(d.getDate()+1);
  document.getElementById('apptDate').min = new Date().toISOString().split('T')[0];
  document.getElementById('apptDate').value = d.toISOString().split('T')[0];
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSection(id) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById('s_'+id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  event?.currentTarget?.classList.add('active');
  const titles={dashboard:'Dashboard',bookAppt:'Book Appointment',myAppts:'My Appointments',myBills:'My Bills',myHistory:'Medical History'};
  document.getElementById('pageTitle').textContent = titles[id]||id;
  const loaders={myAppts:loadAppts, myBills:loadBills, myHistory:loadHistory, bookAppt:loadDeptStep, dashboard:loadDashboard};
  if(loaders[id]) loaders[id]();
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  if(!patientDoc) return;
  try {
    const [appts, bills, encounters] = await Promise.all([
      getList('Patient Appointment',['name','status'],patientDoc?[['patient','=',patientDoc.name]]:[],200),
      getList('Sales Invoice',['name','status','outstanding_amount'],patientDoc?[['patient','=',patientDoc.name],['docstatus','=',1]]:[],200),
      getList('Patient Encounter',['name'],patientDoc?[['patient','=',patientDoc.name]]:[],500)
    ]);
    const today = new Date().toISOString().split('T')[0];
    const upcoming = appts.filter(a=>a.status==='Open');
    document.getElementById('statUpcoming').textContent = upcoming.length;
    document.getElementById('statVisits').textContent = encounters.length;
    document.getElementById('statPending').textContent = bills.filter(b=>parseFloat(b.outstanding_amount)>0).length;
    document.getElementById('statRecords').textContent = encounters.length;
  } catch(e){}
  loadDashAppts();
  loadDashBills();
}

async function loadDashAppts() {
  const el = document.getElementById('dashAppts');
  try {
    if(!patientDoc) { el.innerHTML=emptyState('Login to see appointments'); return; }
    const appts = await getList('Patient Appointment',['name','appointment_date','appointment_time','practitioner','status'],[['patient','=',patientDoc.name],['status','in',['Open','Scheduled']]],5,'appointment_date asc');
    if(!appts.length) { el.innerHTML=emptyState('No upcoming appointments'); return; }
    el.innerHTML=`<table class="data-table"><tbody>${appts.map(a=>`<tr>
      <td class="primary">${a.appointment_date}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px;">${a.appointment_time||'‚Äî'}</td>
      <td>${a.practitioner||'‚Äî'}</td>
      <td><span class="pill pill-blue">${a.status}</span></td>
    </tr>`).join('')}</tbody></table>`;
  } catch(e) { el.innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`; }
}

async function loadDashBills() {
  const el = document.getElementById('dashBills');
  try {
    if(!patientDoc) { el.innerHTML=emptyState('Login to see bills'); return; }
    const bills = await getList('Sales Invoice',['name','posting_date','grand_total','outstanding_amount','status'],[['patient','=',patientDoc.name],['docstatus','=',1]],5,'posting_date desc');
    if(!bills.length) { el.innerHTML=emptyState('No bills found'); return; }
    el.innerHTML=`<table class="data-table"><tbody>${bills.map(b=>`<tr>
      <td class="primary" style="font-family:'DM Mono',monospace;font-size:12px;">${b.name}</td>
      <td>‚Çπ${Number(b.grand_total||0).toLocaleString()}</td>
      <td><span class="pill ${b.outstanding_amount>0?'pill-yellow':'pill-green'}">${b.outstanding_amount>0?'Unpaid':'Paid'}</span></td>
    </tr>`).join('')}</tbody></table>`;
  } catch(e) { el.innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`; }
}

// ‚îÄ‚îÄ‚îÄ BOOKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const stepEls = [null,...[1,2,3,4].map(i=>document.getElementById('bStep'+i))];
let currentStep = 1;

function gotoBookStep(n) {
  [1,2,3,4].forEach(i => {
    document.getElementById('bStep'+i).style.display = i===n?'block':'none';
    const se = document.getElementById('stepEl'+i);
    se.className = 'step' + (i<n?' done':i===n?' active':'');
  });
  currentStep = n;
}

async function loadDeptStep() {
  gotoBookStep(1);
  const grid = document.getElementById('deptGrid');
  grid.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  try {
    const depts = await api('portal_departments');
    const icons = { 'Physiotherapy':'ü¶¥','Neurology':'üß†','Cardiology':'‚ù§Ô∏è','Orthopedics':'ü¶¥','General':'ü©∫','Pediatrics':'üë∂','Psychiatry':'üßò','Ophthalmology':'üëÅ','Dermatology':'üß¥','ENT':'üëÇ' };
    if(!depts?.length) { grid.innerHTML=emptyState('No departments found'); return; }
    grid.innerHTML = depts.map(d=>`
      <div class="dept-card" onclick="selectDept('${d.name}','${escJs(d.name)}')">
        <div class="dept-icon">${icons[d.name]||'üè•'}</div>
        <div class="dept-name">${d.name}</div>
      </div>`).join('');
  } catch(e) {
    // Fallback direct
    try {
      const list = await getList('Medical Department',['name'],[],50);
      const icons = { 'Physiotherapy':'ü¶¥','Neurology':'üß†','Cardiology':'‚ù§Ô∏è','Orthopedics':'ü¶¥','General':'ü©∫' };
      grid.innerHTML = list.map(d=>`
        <div class="dept-card" onclick="selectDept('${d.name}','${escJs(d.name)}')">
          <div class="dept-icon">${icons[d.name]||'üè•'}</div>
          <div class="dept-name">${d.name}</div>
        </div>`).join('');
    } catch(e2) { grid.innerHTML=`<div class="alert alert-error">‚ö† Could not load departments</div>`; }
  }
}

function selectDept(id, name) {
  booking.dept = id; booking.deptName = name;
  document.querySelectorAll('.dept-card').forEach(c=>c.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  setTimeout(()=>loadPracStep(), 200);
}

async function loadPracStep() {
  gotoBookStep(2);
  const grid = document.getElementById('pracGrid');
  grid.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  try {
    const pracs = await api('portal_practitioners', { department: booking.dept });
    if(!pracs?.length) { grid.innerHTML=emptyState('No practitioners in this department'); return; }
    grid.innerHTML = pracs.map(p=>`
      <div class="prac-card" onclick="selectPrac('${p.name}','${escJs(p.practitioner_name||p.name)}')">
        <div class="prac-avatar">üë®‚Äç‚öïÔ∏è</div>
        <div>
          <div class="prac-name">${p.practitioner_name||p.name}</div>
          <div class="prac-dept">${booking.deptName}</div>
        </div>
      </div>`).join('');
  } catch(e) { grid.innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`; }
}

function selectPrac(id, name) {
  booking.prac = id; booking.pracName = name;
  document.querySelectorAll('.prac-card').forEach(c=>c.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  setTimeout(()=>gotoBookStep(3), 200);
}

async function loadSlots() {
  const date = document.getElementById('apptDate').value;
  if(!date||!booking.prac) return;
  booking.date = date;
  const grid = document.getElementById('slotGrid');
  grid.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  document.getElementById('slotNextBtn').disabled = true;
  booking.slot = null;
  try {
    const slots = await api('portal_get_slots', { practitioner: booking.prac, date });
    if(!slots?.length) { grid.innerHTML=`<div style="color:var(--text-muted);font-size:13px;padding:12px;">No available slots for this date</div>`; return; }
    // API returns plain time strings e.g. ["09:00", "09:30", ...]
    grid.innerHTML = slots.map(s=>`
      <div class="slot" onclick="selectSlot(this,'${s}')">${s}</div>
    `).join('');
  } catch(e) {
    // Generate mock slots as fallback
    const times = ['09:00','09:30','10:00','10:30','11:00','11:30','14:00','14:30','15:00','15:30','16:00','16:30'];
    grid.innerHTML = times.map(t=>`<div class="slot" onclick="selectSlot(this,'${t}')">${t}</div>`).join('');
  }
}

function selectSlot(el, time) {
  document.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected'));
  el.classList.add('selected');
  booking.slot = time;
  document.getElementById('slotNextBtn').disabled = false;
}

function gotoBookStep(n) {
  if(n===4) {
    booking.type = document.getElementById('apptType').value;
    document.getElementById('confirmDetails').innerHTML = [
      {label:'Patient', val: patientDoc?.patient_name||'‚Äî'},
      {label:'Department', val: booking.deptName},
      {label:'Doctor', val: booking.pracName},
      {label:'Date', val: booking.date},
      {label:'Time', val: booking.slot},
      {label:'Type', val: booking.type},
    ].map(f=>`<div>
      <div style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-bottom:3px;">${f.label}</div>
      <div style="font-size:13px;font-weight:500;color:var(--text-primary);">${f.val||'‚Äî'}</div>
    </div>`).join('');
  }
  [1,2,3,4].forEach(i=>{
    document.getElementById('bStep'+i).style.display=i===n?'block':'none';
    const se=document.getElementById('stepEl'+i);
    se.className='step'+(i<n?' done':i===n?' active':'');
  });
  currentStep=n;
}

async function confirmBooking() {
  const btn = document.getElementById('confirmBookBtn');
  const alert = document.getElementById('bookingAlert');
  btn.textContent = 'Booking...'; btn.disabled = true;
  try {
    // Server script reads patient from session - just send booking details
    await api('portal_book_appointment', {
      practitioner: booking.prac,
      date: booking.date,
      time: booking.slot,
      appointment_type: booking.type,
      department: booking.dept
    });
    alert.innerHTML = `<div class="alert alert-success">‚úì Appointment booked successfully for ${booking.date} at ${booking.slot}</div>`;
    btn.textContent = '‚úì Booked!';
    setTimeout(()=>{ showSection('myAppts'); }, 2000);
  } catch(e) {
    alert.innerHTML = `<div class="alert alert-error">‚ö† Booking failed: ${e.message||'Please try again'}</div>`;
    btn.textContent='‚úì Confirm Booking'; btn.disabled=false;
  }
}

// ‚îÄ‚îÄ‚îÄ MY APPOINTMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAppts() {
  const tbody = document.getElementById('apptsTbody');
  try {
    if(!patientDoc) { tbody.innerHTML=errRow(7,'Please log in'); return; }
    const appts = await api('patient_my_appointments');
    if(!appts?.length) { tbody.innerHTML=emptyRow(7,'No appointments found'); return; }
    tbody.innerHTML = appts.map(a=>`<tr>
      <td class="primary">${a.appointment_date}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px;">${a.appointment_time||'‚Äî'}</td>
      <td>${a.practitioner||'‚Äî'}</td>
      <td>${a.department||'‚Äî'}</td>
      <td>${a.appointment_type||'‚Äî'}</td>
      <td><span class="pill ${pillClass(a.status)}">${a.status}</span></td>
      <td><a href="/healthcare/patient-appointment/${a.name}" target="_blank" class="btn btn-ghost" style="font-size:12px;padding:4px 10px;">View</a></td>
    </tr>`).join('');
  } catch(e) { tbody.innerHTML=errRow(7,e.message); }
}

// ‚îÄ‚îÄ‚îÄ MY BILLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadBills() {
  const tbody = document.getElementById('billsTbody');
  try {
    if(!patientDoc) { tbody.innerHTML=errRow(6,'Please log in'); return; }
    const invoices = await api('patient_my_invoices');
    if(!invoices?.length) { tbody.innerHTML=emptyRow(6,'No bills found'); return; }
    tbody.innerHTML = invoices.map(inv=>`<tr>
      <td class="primary" style="font-family:'DM Mono',monospace;font-size:12px;">${inv.name}</td>
      <td>${inv.posting_date||'‚Äî'}</td>
      <td>‚Çπ${Number(inv.grand_total||0).toLocaleString()}</td>
      <td style="color:${parseFloat(inv.outstanding_amount)>0?'var(--warning)':'var(--success)'}">‚Çπ${Number(inv.outstanding_amount||0).toLocaleString()}</td>
      <td><span class="pill ${pillClass(inv.status)}">${inv.status}</span></td>
      <td><a href="/printview?doctype=Sales+Invoice&name=${inv.name}&format=Standard" target="_blank" class="btn btn-ghost" style="font-size:12px;padding:4px 10px;">üñ® Print</a></td>
    </tr>`).join('');
  } catch(e) { tbody.innerHTML=errRow(6,e.message); }
}

// ‚îÄ‚îÄ‚îÄ MEDICAL HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadHistory() {
  const el = document.getElementById('historyContent');
  if(!patientDoc) { el.innerHTML=emptyState('Please log in'); return; }
  el.innerHTML=`<div class="loading"><div class="spinner"></div> Loading your medical history...</div>`;
  try {
    const encounters = await getList('Patient Encounter',
      ['name','encounter_date','practitioner','diagnosis','encounter_type'],
      [['patient','=',patientDoc.name]], 100, 'encounter_date desc');
    if(!encounters.length) { el.innerHTML=emptyState('No medical records found'); return; }
    const icons = {'OPD':'ü©∫','IPD':'üè•','Emergency':'üö®',default:'üìã'};
    el.innerHTML = `<div style="position:relative; padding-left:50px;">
      <div style="position:absolute;left:18px;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--blue-500),transparent);"></div>
      ${encounters.map(e=>`
        <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;margin-left:-50px;">
          <div style="width:38px;height:38px;border-radius:50%;background:rgba(26,86,219,.2);border:2px solid var(--blue-400);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;z-index:1;">${icons[e.encounter_type]||icons.default}</div>
          <div style="flex:1;background:rgba(26,86,219,.06);border:1px solid var(--card-border);border-radius:10px;padding:12px 14px;">
            <div style="font-size:11px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:3px;">${e.encounter_date}</div>
            <div style="font-size:13px;font-weight:600;color:var(--text-primary);">${e.encounter_type||'Consultation'} ‚Äî ${e.name}</div>
            ${e.practitioner?`<div style="font-size:12px;color:var(--text-muted);margin-top:3px;">Dr. ${e.practitioner}</div>`:''}
            ${e.diagnosis?`<div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">Dx: ${e.diagnosis}</div>`:''}
          </div>
        </div>`).join('')}
    </div>`;
  } catch(e) { el.innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`; }
}

// ‚îÄ‚îÄ‚îÄ REGISTRATION FEE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function payRegistrationFee() {
  try {
    const fee = await api('get_registration_fee');
    document.getElementById('modalFeeAmt').textContent = `‚Çπ ${fee||0}`;
  } catch(e){}
  document.getElementById('payModal').classList.add('open');
}

async function submitRegPayment() {
  const alertArea = document.getElementById('payAlertArea');
  try {
    const result = await api('create_registration_invoice', {
      patient: patientDoc?.name,
      payment_mode: document.getElementById('payMode').value
    });
    alertArea.innerHTML=`<div class="alert alert-success">‚úì Registration complete! Account activated.</div>`;
    isRegistered = true;
    document.getElementById('regGate').style.display='none';
    document.getElementById('regBadge').textContent='‚úì Active Patient';
    document.getElementById('regBadge').className='reg-badge reg-active';
    setTimeout(()=>closeModal('payModal'), 1500);
  } catch(e) { alertArea.innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`; }
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pillClass(s) {
  s=(s||'').toLowerCase();
  if(['open','active','paid'].some(v=>s.includes(v))) return 'pill-green';
  if(['draft','pending','scheduled'].some(v=>s.includes(v))) return 'pill-yellow';
  if(['cancel'].some(v=>s.includes(v))) return 'pill-red';
  return 'pill-blue';
}
function errRow(cols,msg) { return `<tr><td colspan="${cols}"><div class="alert alert-error">‚ö† ${msg}</div></td></tr>`; }
function emptyRow(cols,msg) { return `<tr><td colspan="${cols}"><div class="empty-state"><div class="icon">üì≠</div><p>${msg}</p></div></td></tr>`; }
function emptyState(msg) { return `<div class="empty-state"><div class="icon">üì≠</div><p>${msg}</p></div>`; }
function escJs(s) { return (s||'').replace(/'/g,"\\'"); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
async function logout() {
  try {
    // Use frappe's proper logout endpoint
    await fetch(`${BASE}/api/method/frappe.auth.logout`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Frappe-CSRF-Token': getCsrf()
      },
      body: JSON.stringify({})
    });
  } catch(e) { /* ignore errors, redirect anyway */ }
  // Clear any local storage keys
  localStorage.clear();
  // Hard redirect to login page
  window.location.replace('/login');
}

init();
</script>
</body>
</html>
