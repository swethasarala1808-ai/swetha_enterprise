<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nurse Portal ‚Äî Rena Rehabilitation Centre</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --navy-900:#050d1a; --navy-800:#0a1628; --navy-700:#0d1f3c;
  --blue-500:#1a56db; --blue-400:#3b82f6; --blue-300:#60a5fa; --blue-200:#93c5fd;
  --accent:#0ea5e9; --accent-glow:rgba(14,165,233,.3);
  --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6;
  --text-primary:#f0f6ff; --text-secondary:#94b8d8; --text-muted:#5a7fa8;
  --card-bg:rgba(13,31,60,.7); --card-border:rgba(59,130,246,.15); --sidebar-w:255px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--navy-900);color:var(--text-primary);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 20% 10%,rgba(26,86,219,.12) 0%,transparent 60%),radial-gradient(ellipse 60% 40% at 80% 80%,rgba(14,165,233,.08) 0%,transparent 50%);pointer-events:none;z-index:0}
.sidebar{position:fixed;top:0;left:0;width:var(--sidebar-w);height:100vh;background:linear-gradient(180deg,var(--navy-800) 0%,var(--navy-900) 100%);border-right:1px solid var(--card-border);display:flex;flex-direction:column;z-index:100;overflow-y:auto}
.brand{padding:22px 18px 16px;border-bottom:1px solid var(--card-border)}
.brand-logo{width:40px;height:40px;background:linear-gradient(135deg,#7c3aed,var(--purple));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:9px;box-shadow:0 4px 16px rgba(139,92,246,.3)}
.brand-name{font-family:'Sora',sans-serif;font-size:13px;font-weight:600;line-height:1.3}
.brand-sub{font-size:11px;color:var(--text-muted);margin-top:2px}
.nurse-info{padding:13px 15px;margin:10px 8px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.2);border-radius:10px}
.nurse-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#4c1d95,var(--purple));display:flex;align-items:center;justify-content:center;font-size:16px;margin-bottom:7px}
.nurse-name{font-family:'Sora',sans-serif;font-size:13px;font-weight:600}
.nurse-role{font-size:11px;color:var(--purple);margin-top:2px;display:flex;align-items:center;gap:4px}
.nav-section{padding:7px 12px 3px;font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted)}
.nav-item{display:flex;align-items:center;gap:10px;padding:8px 15px 8px 18px;margin:1px 7px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--text-secondary);transition:all .18s ease}
.nav-item:hover{background:rgba(59,130,246,.1);color:var(--text-primary)}
.nav-item.active{background:rgba(139,92,246,.15);color:#c4b5fd;border-left:2px solid var(--purple)}
.nav-item .icon{font-size:15px;width:19px;text-align:center}
.nav-badge{margin-left:auto;background:var(--purple);color:white;font-size:10px;font-weight:600;padding:1px 6px;border-radius:10px;font-family:'DM Mono',monospace}
.sidebar-footer{margin-top:auto;padding:10px 7px;border-top:1px solid var(--card-border)}
.main{margin-left:var(--sidebar-w);min-height:100vh;position:relative;z-index:1}
.topbar{position:sticky;top:0;background:rgba(5,13,26,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--card-border);padding:0 26px;height:58px;display:flex;align-items:center;justify-content:space-between;z-index:90}
.page-title{font-family:'Sora',sans-serif;font-size:16px;font-weight:600}
.content{padding:22px 26px}
.section{display:none}
.section.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .18s;font-family:'DM Sans',sans-serif}
.btn-primary{background:var(--blue-500);color:white}
.btn-primary:hover{background:var(--blue-400);transform:translateY(-1px)}
.btn-purple{background:rgba(139,92,246,.2);color:#c4b5fd;border:1px solid rgba(139,92,246,.3)}
.btn-purple:hover{background:rgba(139,92,246,.35)}
.btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid var(--card-border)}
.btn-ghost:hover{background:rgba(59,130,246,.1);color:var(--text-primary)}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px}
.stat-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:13px;padding:18px;position:relative;overflow:hidden;backdrop-filter:blur(10px);transition:transform .2s,box-shadow .2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(139,92,246,.15)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--purple),var(--accent));opacity:.6}
.stat-icon{font-size:22px;margin-bottom:10px}
.stat-value{font-family:'Sora',sans-serif;font-size:26px;font-weight:700;line-height:1}
.stat-label{font-size:12px;color:var(--text-muted);margin-top:4px}
.card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:13px;backdrop-filter:blur(10px);overflow:hidden;margin-bottom:14px}
.card-header{padding:14px 18px;border-bottom:1px solid var(--card-border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-family:'Sora',sans-serif;font-size:14px;font-weight:600}
.data-table{width:100%;border-collapse:collapse}
.data-table th{padding:9px 15px;text-align:left;font-size:11px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text-muted);background:rgba(26,86,219,.06);border-bottom:1px solid var(--card-border)}
.data-table td{padding:11px 15px;font-size:13px;color:var(--text-secondary);border-bottom:1px solid rgba(59,130,246,.06)}
.data-table tr:last-child td{border-bottom:none}
.data-table tr:hover td{background:rgba(59,130,246,.04)}
.data-table .primary{color:var(--text-primary);font-weight:500}
.pill{display:inline-block;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:500}
.pill-green{background:rgba(16,185,129,.15);color:var(--success)}
.pill-blue{background:rgba(59,130,246,.15);color:var(--blue-300)}
.pill-yellow{background:rgba(245,158,11,.15);color:var(--warning)}
.pill-red{background:rgba(239,68,68,.15);color:var(--danger)}
.pill-purple{background:rgba(139,92,246,.15);color:#c4b5fd}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(5,13,26,.87);backdrop-filter:blur(5px);z-index:200;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--navy-700);border:1px solid var(--card-border);border-radius:16px;width:560px;max-width:95vw;max-height:88vh;overflow-y:auto}
.modal-header{padding:18px 22px;border-bottom:1px solid var(--card-border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-family:'Sora',sans-serif;font-size:15px;font-weight:600}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer;padding:2px 7px;border-radius:6px}
.modal-close:hover{background:rgba(239,68,68,.15);color:var(--danger)}
.modal-body{padding:22px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:13px}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-group.full{grid-column:1/-1}
.form-label{font-size:11px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--text-muted)}
.form-input,.form-select,.form-textarea{background:rgba(26,86,219,.06);border:1px solid var(--card-border);border-radius:8px;padding:8px 11px;color:var(--text-primary);font-size:13px;font-family:'DM Sans',sans-serif;outline:none;width:100%;transition:border-color .15s}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--purple);background:rgba(139,92,246,.08)}
.form-select option{background:var(--navy-700)}
.form-textarea{resize:vertical;min-height:70px}
.loading{display:flex;align-items:center;justify-content:center;padding:36px;color:var(--text-muted);font-size:13px;gap:8px}
.spinner{width:15px;height:15px;border:2px solid var(--card-border);border-top-color:var(--purple);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:38px 20px;color:var(--text-muted)}
.empty-state .icon{font-size:34px;margin-bottom:10px;opacity:.5}
.empty-state p{font-size:13px}
.alert{padding:9px 13px;border-radius:8px;font-size:12px;margin-bottom:11px;display:flex;align-items:center;gap:8px}
.alert-info{background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.25);color:var(--accent)}
.alert-success{background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.25);color:var(--success)}
.alert-error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.25);color:var(--danger)}
.vitals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.vital-card{background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.2);border-radius:10px;padding:14px;text-align:center}
.vital-icon{font-size:22px;margin-bottom:5px}
.vital-value{font-family:'Sora',sans-serif;font-size:20px;font-weight:700;color:var(--text-primary)}
.vital-label{font-size:11px;color:var(--text-muted);margin-top:3px}
.vital-unit{font-size:11px;color:var(--purple)}
.link-box{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:10px;padding:13px;margin-bottom:14px;display:flex;align-items:center;gap:11px}
.hr-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:18px}
.hr-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:11px;padding:15px;cursor:pointer;transition:all .2s}
.hr-card:hover{transform:translateY(-2px);border-color:var(--purple)}
.hr-card .hr-icon{font-size:22px;margin-bottom:7px}
.hr-card .hr-title{font-family:'Sora',sans-serif;font-size:13px;font-weight:600}
.hr-card .hr-sub{font-size:12px;color:var(--text-muted);margin-top:2px}
::-webkit-scrollbar{width:6px} ::-webkit-scrollbar-track{background:transparent} ::-webkit-scrollbar-thumb{background:#1e3a5f;border-radius:3px}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="brand">
    <div class="brand-logo">ü©∫</div>
    <div class="brand-name">Rena Rehabilitation</div>
    <div class="brand-sub">Nurse Portal</div>
  </div>

  <div class="nurse-info">
    <div class="nurse-avatar">üë©‚Äç‚öïÔ∏è</div>
    <div class="nurse-name" id="nurseName">Loading...</div>
    <div class="nurse-role"><span style="width:6px;height:6px;border-radius:50%;background:var(--success);display:inline-block;"></span> Nurse</div>
  </div>

  <div class="nav-section">Clinical</div>
  <div class="nav-item active" onclick="showSection('dashboard')"><span class="icon">üìä</span> Dashboard</div>
  <div class="nav-item" onclick="showSection('patients')"><span class="icon">üë•</span> My Patients <span class="nav-badge" id="ptBadge">0</span></div>
  <div class="nav-item" onclick="showSection('vitals')"><span class="icon">üíì</span> Vital Signs</div>
  <div class="nav-item" onclick="showSection('tasks')"><span class="icon">‚úÖ</span> Nursing Tasks</div>
  <div class="nav-item" onclick="showSection('inpatient')"><span class="icon">üõè</span> Inpatient Care</div>
  <div class="nav-item" onclick="showSection('medications')"><span class="icon">üíä</span> Medication Requests</div>

  <div class="nav-section">Account</div>
  <div class="nav-item" onclick="showSection('profile')"><span class="icon">üë§</span> My Profile</div>

  <div class="nav-section">HR</div>
  <div class="nav-item" onclick="showSection('hr')"><span class="icon">üìÅ</span> HR Portal</div>

  <div class="sidebar-footer">
    <div class="nav-item" onclick="logout()" style="color:var(--danger)"><span class="icon">üö™</span> Logout</div>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div class="page-title" id="pageTitle">Dashboard</div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button class="btn btn-ghost" onclick="refreshCurrentSection()">‚Üª Refresh</button>
      <button class="btn btn-purple" onclick="openVitalModal()">+ Record Vitals</button>
    </div>
  </div>

  <div class="content">

    <!-- NURSE LINK -->
    <div id="nurseLinkBox" style="display:none;" class="link-box">
      <div style="font-size:20px;">‚ö†Ô∏è</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:13px;">Link Your Employee Record</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Select your employee to enable HR features.</div>
      </div>
      <select class="form-select" id="empSelect" style="width:200px" onchange="linkEmployee(this.value)">
        <option value="">‚Äî Select Employee ‚Äî</option>
      </select>
    </div>

    <!-- DASHBOARD -->
    <div id="s_dashboard" class="section active">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value" id="statPt">‚Äî</div><div class="stat-label">Patients Today</div></div>
        <div class="stat-card"><div class="stat-icon">üíì</div><div class="stat-value" id="statVitals">‚Äî</div><div class="stat-label">Vitals Recorded</div></div>
        <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="statTasks">‚Äî</div><div class="stat-label">Tasks Pending</div></div>
        <div class="stat-card"><div class="stat-icon">üíä</div><div class="stat-value" id="statMeds">‚Äî</div><div class="stat-label">Med Requests</div></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
        <div class="card">
          <div class="card-header"><span class="card-title">üìÖ Today's Patients</span></div>
          <div id="dashPatients"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">‚úÖ Pending Nursing Tasks</span></div>
          <div id="dashTasks"><div class="loading"><div class="spinner"></div></div></div>
        </div>
      </div>
    </div>

    <!-- PATIENTS -->
    <div id="s_patients" class="section">
      <div class="card">
        <div class="card-header">
          <span class="card-title">üë• Patient List</span>
          <input type="text" class="form-input" placeholder="Search..." oninput="filterPt(this.value)" style="width:200px;">
        </div>
        <table class="data-table">
          <thead><tr><th>Patient</th><th>Ward/Bed</th><th>Admission</th><th>Condition</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="ptTbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- VITAL SIGNS -->
    <div id="s_vitals" class="section">
      <div class="vitals-grid">
        <div class="vital-card"><div class="vital-icon">‚ù§Ô∏è</div><div class="vital-value" id="avgBP">‚Äî</div><div class="vital-unit">mmHg</div><div class="vital-label">Avg Blood Pressure</div></div>
        <div class="vital-card"><div class="vital-icon">ü´Ä</div><div class="vital-value" id="avgPulse">‚Äî</div><div class="vital-unit">bpm</div><div class="vital-label">Avg Heart Rate</div></div>
        <div class="vital-card"><div class="vital-icon">üå°Ô∏è</div><div class="vital-value" id="avgTemp">‚Äî</div><div class="vital-unit">¬∞F</div><div class="vital-label">Avg Temperature</div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">üíì Vital Signs Records</span>
          <button class="btn btn-purple" onclick="openVitalModal()">+ Record</button>
        </div>
        <table class="data-table">
          <thead><tr><th>Patient</th><th>Date/Time</th><th>BP</th><th>Pulse</th><th>Temp</th><th>SpO2</th><th>Status</th></tr></thead>
          <tbody id="vitalsTbody"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- NURSING TASKS -->
    <div id="s_tasks" class="section">
      <div class="card">
        <div class="card-header">
          <span class="card-title">‚úÖ Nursing Tasks</span>
          <button class="btn btn-purple">+ New Task</button>
        </div>
        <table class="data-table">
          <thead><tr><th>Task</th><th>Patient</th><th>Date</th><th>Priority</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="tasksTbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- INPATIENT -->
    <div id="s_inpatient" class="section">
      <div class="card">
        <div class="card-header"><span class="card-title">üõè Inpatient Records</span></div>
        <table class="data-table">
          <thead><tr><th>Patient</th><th>Ward</th><th>Bed</th><th>Admission</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="inpatientTbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- MEDICATIONS -->
    <div id="s_medications" class="section">
      <div class="card">
        <div class="card-header"><span class="card-title">üíä Medication Requests</span></div>
        <table class="data-table">
          <thead><tr><th>ID</th><th>Patient</th><th>Medication</th><th>Dosage</th><th>Status</th><th>Date</th></tr></thead>
          <tbody id="medTbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- HR -->
    <div id="s_hr" class="section">
      <div class="hr-cards">
        <div class="hr-card" onclick="loadAttendance()"><div class="hr-icon">üïê</div><div class="hr-title">Attendance</div><div class="hr-sub">Check-in records</div></div>
        <div class="hr-card" onclick="loadLeave()"><div class="hr-icon">üå¥</div><div class="hr-title">Leave</div><div class="hr-sub">Leave applications</div></div>
        <div class="hr-card" onclick="loadPayroll()"><div class="hr-icon">üí∞</div><div class="hr-title">Payroll</div><div class="hr-sub">Salary slips</div></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title" id="hrTitle">Select a section</span></div>
        <div id="hrBody"><div class="empty-state"><div class="icon">üìÅ</div><p>Select a section above</p></div></div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="s_profile" class="section">
      <div class="card">
        <div class="card-header"><span class="card-title">üë§ My Profile</span></div>
        <div id="profileBody"><div class="loading"><div class="spinner"></div></div></div>
      </div>
      <div class="card" style="margin-top:14px;">
        <div class="card-header"><span class="card-title">üîó Employee Link</span></div>
        <div style="padding:16px;">
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Link your employee profile for HR features:</p>
          <select id="profileEmpSelect" style="background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.2);border-radius:8px;padding:8px 12px;color:var(--text-primary);font-size:13px;font-family:inherit;outline:none;max-width:320px;" onchange="linkEmployee(this.value)">
            <option value="">‚Äî Select Employee ‚Äî</option>
          </select>
          <div id="profileEmpStatus" style="margin-top:8px;font-size:12px;color:var(--success);"></div>
        </div>
      </div>
    </div>

  </div>
</main>

<!-- VITAL SIGNS MODAL -->
<div class="modal-overlay" id="vitalModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Record Vital Signs</div>
      <button class="modal-close" onclick="closeModal('vitalModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="vitalAlert"></div>
      <div class="form-grid">
        <div class="form-group full">
          <label class="form-label">Patient *</label>
          <input class="form-input" id="vPatient" placeholder="Patient name/ID">
        </div>
        <div class="form-group">
          <label class="form-label">Blood Pressure (mmHg)</label>
          <input class="form-input" id="vBP" placeholder="e.g. 120/80">
        </div>
        <div class="form-group">
          <label class="form-label">Pulse (bpm)</label>
          <input class="form-input" id="vPulse" type="number" placeholder="e.g. 72">
        </div>
        <div class="form-group">
          <label class="form-label">Temperature (¬∞F)</label>
          <input class="form-input" id="vTemp" type="number" step="0.1" placeholder="e.g. 98.6">
        </div>
        <div class="form-group">
          <label class="form-label">SpO2 (%)</label>
          <input class="form-input" id="vSpO2" type="number" placeholder="e.g. 98">
        </div>
        <div class="form-group">
          <label class="form-label">Respiratory Rate</label>
          <input class="form-input" id="vResp" type="number" placeholder="breaths/min">
        </div>
        <div class="form-group">
          <label class="form-label">Weight (kg)</label>
          <input class="form-input" id="vWeight" type="number" step="0.1">
        </div>
        <div class="form-group full">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="vNotes"></textarea>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:14px;">
        <button class="btn btn-ghost" onclick="closeModal('vitalModal')">Cancel</button>
        <button class="btn btn-purple" onclick="saveVitals()">Save Vitals</button>
      </div>
    </div>
  </div>
</div>

<script>
const BASE='';
let currentUser=null, employeeName=null, allPt=[];

async function api(method,args={}){
  const r=await fetch(`${BASE}/api/method/${method}`,{method:'POST',headers:{'Content-Type':'application/json','X-Frappe-CSRF-Token':getCsrf()},body:JSON.stringify(args)});
  const d=await r.json(); if(d.exc) throw new Error(d.exc); return d.message??d;
}
async function getList(dt,fields=['name'],filters=[],limit=50,order='modified desc'){
  const p=new URLSearchParams({doctype:dt,fields:JSON.stringify(fields),filters:JSON.stringify(filters),limit_page_length:limit,order_by:order});
  const r=await fetch(`${BASE}/api/resource/${encodeURIComponent(dt)}?${p}`,{headers:{'X-Frappe-CSRF-Token':getCsrf()}});
  return (await r.json()).data||[];
}
async function getDoc(dt,name){
  const r=await fetch(`${BASE}/api/resource/${encodeURIComponent(dt)}/${encodeURIComponent(name)}`,{headers:{'X-Frappe-CSRF-Token':getCsrf()}});
  return (await r.json()).data||null;
}
function getCsrf(){
  if(typeof frappe!=='undefined'&&frappe.csrf_token) return frappe.csrf_token;
  return (document.cookie.match(/csrftoken=([^;]+)/)||[])[1]||'';
}

async function init(){
  try{
    const user=await api('frappe.auth.get_logged_user');
    currentUser=typeof user==='string'?user:user?.message;
    if(!currentUser||currentUser==='Guest'){window.location.replace('/login');return;}
    document.getElementById('nurseName').textContent=currentUser||'Nurse';
  }catch(e){window.location.replace('/login');return;}

  // Try to auto-link employee by user_id
  try{
    const emp=await getList('Employee',['name','employee_name'],[['user_id','=',currentUser]],1);
    if(emp.length){
      employeeName=emp[0].name;
      localStorage.setItem('rrc_nurse_emp',employeeName);
      document.getElementById('nurseLinkBox').style.display='none';
    } else {
      const savedEmp=localStorage.getItem('rrc_nurse_emp');
      if(savedEmp) employeeName=savedEmp;
      else offerEmpLink();
    }
  }catch(e){
    const savedEmp=localStorage.getItem('rrc_nurse_emp');
    if(savedEmp) employeeName=savedEmp;
    else offerEmpLink();
  }
  loadDashboard();
}

async function offerEmpLink(){
  try{
    const list=await getList('Employee',['name','employee_name'],[],100);
    if(!list.length) return;
    const sel=document.getElementById('empSelect');
    list.forEach(e=>{const o=document.createElement('option');o.value=e.name;o.textContent=`${e.employee_name} (${e.name})`;sel.appendChild(o);});
    document.getElementById('nurseLinkBox').style.display='flex';
  }catch(e){}
}
function linkEmployee_old_removed(val){}

function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById('s_'+id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  event?.currentTarget?.classList.add('active');
  const titles={dashboard:'Dashboard',patients:'My Patients',vitals:'Vital Signs',tasks:'Nursing Tasks',inpatient:'Inpatient Care',medications:'Medication Requests',hr:'HR Portal',profile:'My Profile'};
  document.getElementById('pageTitle').textContent=titles[id]||id;
  const loaders={patients:loadPatients,vitals:loadVitals,tasks:loadTasks,inpatient:loadInpatient,medications:loadMedications,profile:loadProfile};
  if(loaders[id]) loaders[id]();
}

async function loadProfile(){
  const el=document.getElementById('profileBody');
  el.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const rows=[
      ['üë§ Logged in as', currentUser||'‚Äî'],
      ['üÜî Employee ID', employeeName||'Not linked'],
    ];
    if(employeeName){
      try{
        const emp=await getDoc('Employee',employeeName);
        if(emp){
          rows.push(['üìõ Name',emp.employee_name||'‚Äî']);
          rows.push(['üè• Department',emp.department||'‚Äî']);
          rows.push(['üìû Phone',emp.cell_number||emp.personal_email||'‚Äî']);
          rows.push(['üìÖ Date of Joining',emp.date_of_joining||'‚Äî']);
        }
      }catch(e){}
    }
    el.innerHTML=`<table class="data-table"><tbody>${rows.map(r=>`<tr>
      <td style="font-size:12px;color:var(--text-muted);width:160px;">${r[0]}</td>
      <td style="font-size:13px;font-weight:500;">${r[1]}</td>
    </tr>`).join('')}</tbody></table>`;
    // Populate emp select
    try{
      const list=await getList('Employee',['name','employee_name'],[],100);
      const sel=document.getElementById('profileEmpSelect');
      sel.innerHTML='<option value="">‚Äî Select Employee ‚Äî</option>';
      list.forEach(e=>{const o=document.createElement('option');o.value=e.name;o.textContent=`${e.employee_name||e.name} (${e.name})`;sel.appendChild(o);});
      if(employeeName) sel.value=employeeName;
    }catch(e){}
  }catch(e){el.innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`;}
}

function linkEmployee(val){
  if(!val) return;
  employeeName=val; localStorage.setItem('rrc_nurse_emp',val);
  document.getElementById('nurseLinkBox').style.display='none';
  if(document.getElementById('profileEmpStatus')) document.getElementById('profileEmpStatus').textContent='‚úì Employee linked: '+val;
}
function refreshCurrentSection(){const a=document.querySelector('.section.active');if(a){const id=a.id.replace('s_','');const m={dashboard:loadDashboard,patients:loadPatients,vitals:loadVitals,tasks:loadTasks,inpatient:loadInpatient,medications:loadMedications};if(m[id])m[id]();}}

async function loadDashboard(){
  loadDashPt(); loadDashTasks();
  try{
    const [pt,vitals,tasks,meds]=await Promise.all([
      getList('Patient',['name'],[],500),
      getList('Vital Signs',['name'],[],200),
      getList('Patient Activity',['name','status'],[['status','!=','Completed']],200),
      getList('Medication Request',['name','status'],[['status','=','Pending']],200)
    ]);
    document.getElementById('statPt').textContent=pt.length;
    document.getElementById('statVitals').textContent=vitals.length;
    document.getElementById('statTasks').textContent=tasks.length;
    document.getElementById('statMeds').textContent=meds.length;
    document.getElementById('ptBadge').textContent=pt.length;
  }catch(e){}
}

async function loadDashPt(){
  const el=document.getElementById('dashPatients');
  try{
    const today=new Date().toISOString().split('T')[0];
    const appts=await getList('Patient Appointment',['name','patient_name','appointment_time','status'],[['appointment_date','=',today]],10);
    if(!appts.length){el.innerHTML=emptyState('No patients today');return;}
    el.innerHTML=`<table class="data-table"><tbody>${appts.map(a=>`<tr>
      <td class="primary">${a.patient_name}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px;">${a.appointment_time||'‚Äî'}</td>
      <td><span class="pill ${pillCls(a.status)}">${a.status}</span></td>
    </tr>`).join('')}</tbody></table>`;
  }catch(e){el.innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`;}
}

async function loadDashTasks(){
  const el=document.getElementById('dashTasks');
  try{
    const tasks=await getList('Patient Activity',['name','activity_type','patient','status'],[['status','!=','Completed']],10);
    if(!tasks.length){el.innerHTML=emptyState('No pending tasks');return;}
    el.innerHTML=`<table class="data-table"><tbody>${tasks.map(t=>`<tr>
      <td class="primary">${t.activity_type||t.name}</td>
      <td>${t.patient||'‚Äî'}</td>
      <td><span class="pill ${pillCls(t.status)}">${t.status||'Pending'}</span></td>
    </tr>`).join('')}</tbody></table>`;
  }catch(e){el.innerHTML=emptyState('No nursing task data available');}
}

async function loadPatients(){
  const tbody=document.getElementById('ptTbody');
  try{
    const list=await getList('Patient',['name','patient_name','sex','mobile','status'],[],200);
    allPt=list;
    renderPt(list);
  }catch(e){tbody.innerHTML=errRow(6,e.message);}
}
function renderPt(list){
  const tbody=document.getElementById('ptTbody');
  if(!list.length){tbody.innerHTML=emptyRow(6,'No patients found');return;}
  tbody.innerHTML=list.map(p=>`<tr>
    <td class="primary">${p.patient_name}</td>
    <td>‚Äî</td><td>‚Äî</td><td>${p.sex||'‚Äî'}</td>
    <td><span class="pill ${pillCls(p.status)}">${p.status||'Active'}</span></td>
    <td><button class="btn btn-ghost" style="font-size:12px;padding:4px 9px;" onclick="openVitalForPatient('${p.name}','${escJs(p.patient_name)}')">Record Vitals</button></td>
  </tr>`).join('');
}
function filterPt(q){if(!q){renderPt(allPt);return;}renderPt(allPt.filter(p=>(p.patient_name||'').toLowerCase().includes(q.toLowerCase())));}

async function loadVitals(){
  const tbody=document.getElementById('vitalsTbody');
  try{
    const list=await getList('Vital Signs',['name','patient','signs_date','bp_systolic','bp_diastolic','pulse','temperature','oxygen_saturation'],[],100,'signs_date desc');
    if(!list.length){tbody.innerHTML=emptyRow(7,'No vitals recorded');return;}
    // Compute averages
    const pulses=list.map(v=>parseFloat(v.pulse)||0).filter(Boolean);
    const temps=list.map(v=>parseFloat(v.temperature)||0).filter(Boolean);
    if(pulses.length) document.getElementById('avgPulse').textContent=(pulses.reduce((a,b)=>a+b,0)/pulses.length).toFixed(0);
    if(temps.length) document.getElementById('avgTemp').textContent=(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1);
    tbody.innerHTML=list.map(v=>`<tr>
      <td class="primary">${v.patient||'‚Äî'}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px;">${(v.signs_date||'').substring(0,16)}</td>
      <td style="font-family:'DM Mono',monospace;">${v.bp_systolic&&v.bp_diastolic?v.bp_systolic+'/'+v.bp_diastolic:'‚Äî'}</td>
      <td>${v.pulse||'‚Äî'}</td>
      <td>${v.temperature||'‚Äî'}</td>
      <td>${v.oxygen_saturation||'‚Äî'}</td>
      <td><span class="pill pill-blue">Recorded</span></td>
    </tr>`).join('');
  }catch(e){tbody.innerHTML=errRow(7,e.message);}
}

async function loadTasks(){
  const tbody=document.getElementById('tasksTbody');
  try{
    const list=await getList('Patient Activity',['name','activity_type','patient','due_date','status'],[],100,'due_date asc');
    if(!list.length){tbody.innerHTML=emptyRow(6,'No nursing tasks');return;}
    tbody.innerHTML=list.map(t=>`<tr>
      <td class="primary">${t.activity_type||'Task'}</td>
      <td>${t.patient||'‚Äî'}</td>
      <td>${t.due_date||'‚Äî'}</td>
      <td><span class="pill pill-yellow">Normal</span></td>
      <td><span class="pill ${pillCls(t.status)}">${t.status||'Pending'}</span></td>
      <td><button class="btn btn-ghost" style="font-size:12px;padding:4px 9px;">Complete</button></td>
    </tr>`).join('');
  }catch(e){tbody.innerHTML=emptyRow(6,'Nursing task data unavailable');}
}

async function loadInpatient(){
  const tbody=document.getElementById('inpatientTbody');
  try{
    const list=await getList('Inpatient Record',['name','patient','patient_name','admitted_datetime','status','bed'],[],100);
    if(!list.length){tbody.innerHTML=emptyRow(6,'No inpatient records');return;}
    tbody.innerHTML=list.map(r=>`<tr>
      <td class="primary">${r.patient_name||r.patient}</td>
      <td>‚Äî</td>
      <td>${r.bed||'‚Äî'}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px;">${(r.admitted_datetime||'').substring(0,10)}</td>
      <td><span class="pill ${pillCls(r.status)}">${r.status||'Active'}</span></td>
      <td><a href="/healthcare/inpatient-record/${r.name}" target="_blank" class="btn btn-ghost" style="font-size:12px;padding:4px 9px;">View</a></td>
    </tr>`).join('');
  }catch(e){tbody.innerHTML=errRow(6,e.message);}
}

async function loadMedications(){
  const tbody=document.getElementById('medTbody');
  try{
    const list=await getList('Medication Request',['name','patient','medication','dosage','status','modified'],[],100);
    if(!list.length){tbody.innerHTML=emptyRow(6,'No medication requests');return;}
    tbody.innerHTML=list.map(m=>`<tr>
      <td class="primary" style="font-family:'DM Mono',monospace;font-size:12px;">${m.name}</td>
      <td>${m.patient||'‚Äî'}</td>
      <td>${m.medication||'‚Äî'}</td>
      <td>${m.dosage||'‚Äî'}</td>
      <td><span class="pill ${pillCls(m.status)}">${m.status||'Pending'}</span></td>
      <td style="font-size:12px;">${(m.modified||'').substring(0,10)}</td>
    </tr>`).join('');
  }catch(e){tbody.innerHTML=errRow(6,e.message);}
}

// HR
async function loadAttendance(){
  document.getElementById('hrTitle').textContent='üïê Attendance Records';
  document.getElementById('hrBody').innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const filters=employeeName?[['employee','=',employeeName]]:[];
    const list=await getList('Attendance',['name','attendance_date','status','in_time','out_time'],filters,30,'attendance_date desc');
    if(!list.length){document.getElementById('hrBody').innerHTML=emptyState('No attendance records');return;}
    document.getElementById('hrBody').innerHTML=`<table class="data-table"><thead><tr><th>Date</th><th>Status</th><th>In</th><th>Out</th></tr></thead><tbody>${list.map(a=>`<tr>
      <td>${a.attendance_date}</td>
      <td><span class="pill ${pillCls(a.status)}">${a.status}</span></td>
      <td style="font-family:'DM Mono',monospace;font-size:12px;">${a.in_time||'‚Äî'}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px;">${a.out_time||'‚Äî'}</td>
    </tr>`).join('')}</tbody></table>`;
  }catch(e){document.getElementById('hrBody').innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`;}
}

async function loadLeave(){
  document.getElementById('hrTitle').textContent='üå¥ Leave Applications';
  document.getElementById('hrBody').innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const filters=employeeName?[['employee','=',employeeName]]:[];
    const list=await getList('Leave Application',['name','leave_type','from_date','to_date','status'],filters,30,'from_date desc');
    if(!list.length){document.getElementById('hrBody').innerHTML=emptyState('No leave applications');return;}
    document.getElementById('hrBody').innerHTML=`<table class="data-table"><thead><tr><th>Type</th><th>From</th><th>To</th><th>Status</th></tr></thead><tbody>${list.map(l=>`<tr>
      <td>${l.leave_type}</td><td>${l.from_date}</td><td>${l.to_date}</td>
      <td><span class="pill ${pillCls(l.status)}">${l.status}</span></td>
    </tr>`).join('')}</tbody></table>`;
  }catch(e){document.getElementById('hrBody').innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`;}
}

async function loadPayroll(){
  document.getElementById('hrTitle').textContent='üí∞ Salary Slips';
  document.getElementById('hrBody').innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const filters=employeeName?[['employee','=',employeeName]]:[];
    const list=await getList('Salary Slip',['name','start_date','end_date','net_pay','status'],filters,24,'start_date desc');
    if(!list.length){document.getElementById('hrBody').innerHTML=emptyState('No salary slips');return;}
    document.getElementById('hrBody').innerHTML=`<table class="data-table"><thead><tr><th>Period</th><th>Net Pay</th><th>Status</th><th>Print</th></tr></thead><tbody>${list.map(s=>`<tr>
      <td>${s.start_date} ‚Üí ${s.end_date}</td>
      <td style="font-family:'DM Mono',monospace;">‚Çπ${Number(s.net_pay||0).toLocaleString()}</td>
      <td><span class="pill ${pillCls(s.status)}">${s.status}</span></td>
      <td><a href="/printview?doctype=Salary+Slip&name=${s.name}&format=Standard" target="_blank" class="btn btn-ghost" style="font-size:12px;padding:3px 9px;">Print</a></td>
    </tr>`).join('')}</tbody></table>`;
  }catch(e){document.getElementById('hrBody').innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`;}
}

// VITALS
function openVitalModal(){document.getElementById('vitalModal').classList.add('open');}
function openVitalForPatient(id,name){document.getElementById('vPatient').value=name||id;openVitalModal();}

async function saveVitals(){
  const alertEl=document.getElementById('vitalAlert');
  const patient=document.getElementById('vPatient').value.trim();
  if(!patient){alertEl.innerHTML=`<div class="alert alert-error">‚ö† Patient is required</div>`;return;}
  try{
    const bp=document.getElementById('vBP').value.split('/');
    await api('frappe.client.insert',{doc:{
      doctype:'Vital Signs',
      patient,
      signs_date:new Date().toISOString().slice(0,19).replace('T',' '),
      bp_systolic:bp[0]||null,
      bp_diastolic:bp[1]||null,
      pulse:document.getElementById('vPulse').value||null,
      temperature:document.getElementById('vTemp').value||null,
      oxygen_saturation:document.getElementById('vSpO2').value||null,
      respiratory_rate:document.getElementById('vResp').value||null,
      weight:document.getElementById('vWeight').value||null,
      notes:document.getElementById('vNotes').value||null
    }});
    alertEl.innerHTML=`<div class="alert alert-success">‚úì Vital signs recorded successfully</div>`;
    setTimeout(()=>closeModal('vitalModal'),1200);
    loadVitals();
  }catch(e){alertEl.innerHTML=`<div class="alert alert-error">‚ö† ${e.message}</div>`;}
}

function pillCls(s){
  s=(s||'').toLowerCase();
  if(['active','open','present','paid','completed'].some(v=>s.includes(v)))return 'pill-green';
  if(['pending','draft','scheduled'].some(v=>s.includes(v)))return 'pill-yellow';
  if(['cancel','absent','inactive'].some(v=>s.includes(v)))return 'pill-red';
  return 'pill-blue';
}
function errRow(c,m){return `<tr><td colspan="${c}"><div class="alert alert-error">‚ö† ${m}</div></td></tr>`;}
function emptyRow(c,m){return `<tr><td colspan="${c}"><div class="empty-state"><div class="icon">üì≠</div><p>${m}</p></div></td></tr>`;}
function emptyState(m){return `<div class="empty-state"><div class="icon">üì≠</div><p>${m}</p></div>`;}
function escJs(s){return (s||'').replace(/'/g,"\\'");}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
async function logout(){
  try{
    await fetch(`${BASE}/api/method/frappe.auth.logout`,{method:'POST',headers:{'Content-Type':'application/json','X-Frappe-CSRF-Token':getCsrf()},body:JSON.stringify({})});
  }catch(e){}
  localStorage.clear();
  window.location.replace('/login');
}

init();
</script>
</body>
</html>
