<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doctor Portal | Sneha Health</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #05152e;
  --navy-2: #0a2144;
  --navy-3: #0f2d5c;
  --blue: #1565c0;
  --blue-bright: #1e88e5;
  --blue-light: #42a5f5;
  --cyan: #00b4d8;
  --cyan-light: #48cae4;
  --teal: #00897b;
  --surface: #0d1f3c;
  --surface-2: #112547;
  --card: #132a52;
  --card-2: #163060;
  --border: rgba(30,136,229,0.18);
  --border-bright: rgba(66,165,245,0.35);
  --text: #e8f0fe;
  --text-2: #90a8d0;
  --text-3: #5a7aaa;
  --green: #00c853;
  --amber: #ffab00;
  --red: #ff1744;
  --purple: #7c4dff;
  --sidebar-w: 268px;
  --radius: 14px;
  --radius-sm: 8px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Sora', sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 4px; }

/* â”€â”€ OVERLAY â”€â”€ */
.overlay {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(135deg, #020c1e 0%, #051535 50%, #071a3e 100%);
  display: flex; align-items: center; justify-content: center;
}

.overlay-card {
  background: var(--card);
  border: 1px solid var(--border-bright);
  border-radius: 24px;
  padding: 2.5rem 2rem;
  width: 100%; max-width: 420px;
  box-shadow: 0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(66,165,245,0.08);
  text-align: center;
}

.overlay-logo {
  width: 64px; height: 64px;
  background: linear-gradient(135deg, var(--blue), var(--cyan));
  border-radius: 18px;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 1.5rem;
  box-shadow: 0 8px 32px rgba(21,101,192,0.5);
}

.overlay-logo svg { width: 28px; height: 28px; }

.overlay-card h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem; }
.overlay-card p { color: var(--text-2); font-size: 0.875rem; }

.login-form { margin-top: 1.75rem; text-align: left; }
.login-form label { font-size: 0.75rem; font-weight: 600; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.08em; display: block; margin-bottom: 0.4rem; }
.login-form input {
  width: 100%; padding: 0.75rem 1rem;
  background: var(--navy-3); border: 1px solid var(--border);
  border-radius: var(--radius-sm); color: var(--text);
  font-family: inherit; font-size: 0.9rem;
  margin-bottom: 1rem; transition: border-color 0.2s;
}
.login-form input:focus { outline: none; border-color: var(--blue-bright); }

.btn-primary {
  width: 100%; padding: 0.85rem;
  background: linear-gradient(135deg, var(--blue) 0%, var(--blue-bright) 100%);
  color: #fff; border: none; border-radius: var(--radius-sm);
  font-family: inherit; font-size: 0.9rem; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(21,101,192,0.4);
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(21,101,192,0.5); }

.diag { margin-top: 1.5rem; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 0.5rem 0.75rem; max-height: 80px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-3); text-align: left; }

.picker-list { max-height: 180px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); margin-top: 1rem; }
.picker-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.85rem; transition: background 0.15s; }
.picker-item:hover { background: var(--navy-3); color: var(--blue-light); }
.picker-item:last-child { border-bottom: none; }
.picker-item .pid { font-size: 0.72rem; color: var(--text-3); font-family: monospace; }

.hidden { display: none !important; }

/* â”€â”€ APP SHELL â”€â”€ */
.app-shell { display: flex; min-height: 100vh; }

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: var(--sidebar-w);
  background: linear-gradient(180deg, var(--navy-2) 0%, var(--navy) 100%);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  position: fixed; height: 100vh; z-index: 100;
  overflow-y: auto;
}

.sidebar-header {
  padding: 1.5rem 1.25rem;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 0.75rem;
}

.logo-icon {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, var(--blue), var(--cyan));
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(21,101,192,0.4);
}

.logo-icon svg { width: 20px; height: 20px; }

.logo-text { font-size: 1rem; font-weight: 700; color: var(--text); }
.logo-sub { font-size: 0.7rem; color: var(--text-3); }

.sidebar-nav { flex: 1; padding: 1rem 0.75rem; }

.nav-group-label {
  font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--text-3);
  padding: 1rem 0.75rem 0.4rem; margin-top: 0.25rem;
}

.nav-item {
  display: flex; align-items: center; gap: 0.75rem;
  padding: 0.65rem 0.875rem;
  border-radius: 10px;
  cursor: pointer; transition: all 0.18s;
  color: var(--text-2); font-weight: 500; font-size: 0.875rem;
  margin-bottom: 2px; position: relative;
}

.nav-item:hover { background: rgba(30,136,229,0.12); color: var(--blue-light); }

.nav-item.active {
  background: linear-gradient(135deg, rgba(21,101,192,0.35), rgba(0,180,216,0.15));
  color: #fff;
  box-shadow: inset 0 0 0 1px rgba(66,165,245,0.2);
}

.nav-item.active::before {
  content: '';
  position: absolute; left: 0; top: 20%; height: 60%; width: 3px;
  background: linear-gradient(var(--blue-bright), var(--cyan));
  border-radius: 0 2px 2px 0;
}

.nav-icon { font-size: 1rem; width: 1.25rem; text-align: center; flex-shrink: 0; }

.nav-locked { opacity: 0.4; cursor: not-allowed; }
.nav-locked:hover { background: transparent; color: var(--text-2); }

.sidebar-footer {
  padding: 1rem 0.875rem;
  border-top: 1px solid var(--border);
}

.user-card {
  display: flex; align-items: center; gap: 0.75rem;
  background: var(--surface-2); border-radius: 12px;
  padding: 0.75rem; margin-bottom: 0.75rem;
  border: 1px solid var(--border);
}

.avatar {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--blue), var(--cyan));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 1rem; flex-shrink: 0;
}

.user-name { font-weight: 600; font-size: 0.85rem; }
.user-role { font-size: 0.7rem; color: var(--text-3); }

.btn-logout {
  width: 100%; padding: 0.55rem;
  background: transparent; border: 1px solid rgba(255,23,68,0.25);
  border-radius: 8px; color: var(--red); font-family: inherit;
  font-size: 0.8rem; font-weight: 500; cursor: pointer;
  transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.4rem;
}
.btn-logout:hover { background: rgba(255,23,68,0.1); border-color: var(--red); }

/* â”€â”€ MAIN â”€â”€ */
.main-content { margin-left: var(--sidebar-w); flex: 1; }

.top-header {
  height: 64px;
  background: rgba(10,33,68,0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 0 2rem;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 90;
}

.page-title { font-size: 1.35rem; font-weight: 700; color: var(--text); }

.header-right { display: flex; align-items: center; gap: 1rem; }

.date-chip {
  padding: 0.35rem 0.875rem;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; font-size: 0.78rem; color: var(--text-2);
  font-family: 'JetBrains Mono', monospace;
}

.prac-banner {
  margin: 1.5rem 2rem 0;
  padding: 0.875rem 1.25rem;
  background: rgba(255,171,0,0.1);
  border: 1px solid rgba(255,171,0,0.3);
  border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: space-between;
  gap: 1rem;
}
.prac-banner p { font-size: 0.85rem; color: var(--amber); }
.prac-banner button {
  padding: 0.35rem 0.875rem;
  background: var(--amber); color: #000;
  border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.78rem; white-space: nowrap;
}

.content-body { padding: 1.75rem 2rem; }

/* â”€â”€ SECTIONS â”€â”€ */
.section { display: none; animation: fadeUp 0.28s ease-out; }
.section.active { display: block; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* â”€â”€ STATS GRID â”€â”€ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.25rem; margin-bottom: 1.75rem;
}

.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.25rem;
  display: flex; align-items: center; gap: 1rem;
  transition: all 0.2s; cursor: default;
  position: relative; overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: var(--accent-color, var(--blue));
  border-radius: var(--radius) var(--radius) 0 0;
}

.stat-card:hover { transform: translateY(-2px); border-color: var(--border-bright); }

.stat-card.blue { --accent-color: var(--blue-bright); }
.stat-card.cyan { --accent-color: var(--cyan); }
.stat-card.green { --accent-color: var(--green); }
.stat-card.amber { --accent-color: var(--amber); }
.stat-card.purple { --accent-color: var(--purple); }

.stat-icon {
  width: 46px; height: 46px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
  background: rgba(30,136,229,0.12);
  flex-shrink: 0;
}

.stat-label { font-size: 0.75rem; color: var(--text-2); font-weight: 500; margin-bottom: 0.25rem; }
.stat-value { font-size: 1.75rem; font-weight: 800; color: var(--text); font-family: 'JetBrains Mono', monospace; }

/* â”€â”€ CARDS â”€â”€ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden; margin-bottom: 1.5rem;
}

.card-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}

.card-title { font-size: 1rem; font-weight: 700; }

.card-body { padding: 1.25rem; }

.dashboard-grid {
  display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;
}

/* â”€â”€ DATA ROWS â”€â”€ */
.data-row {
  padding: 0.875rem 1rem;
  background: var(--surface-2); border-radius: 10px;
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 0.6rem; cursor: pointer; transition: all 0.18s;
  position: relative; overflow: hidden;
}

.data-row::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--blue); border-radius: 2px 0 0 2px;
  opacity: 0; transition: opacity 0.18s;
}

.data-row:hover { border-color: var(--border-bright); background: var(--card-2); transform: translateX(3px); }
.data-row:hover::before { opacity: 1; }

.row-info b { display: block; font-size: 0.9rem; margin-bottom: 0.2rem; }
.row-info span { font-size: 0.78rem; color: var(--text-2); }
.row-arrow { font-size: 0.75rem; color: var(--text-3); transition: color 0.18s; }
.data-row:hover .row-arrow { color: var(--blue-light); }

/* â”€â”€ BADGES â”€â”€ */
.badge {
  padding: 3px 10px; border-radius: 20px;
  font-size: 0.7rem; font-weight: 700; white-space: nowrap;
  display: flex; align-items: center; gap: 3px;
}
.badge-success { background: rgba(0,200,83,0.12); color: var(--green); border: 1px solid rgba(0,200,83,0.2); }
.badge-warn { background: rgba(255,171,0,0.12); color: var(--amber); border: 1px solid rgba(255,171,0,0.2); }
.badge-error { background: rgba(255,23,68,0.12); color: var(--red); border: 1px solid rgba(255,23,68,0.2); }
.badge-info { background: rgba(30,136,229,0.12); color: var(--blue-light); border: 1px solid rgba(30,136,229,0.2); }
.badge-cyan { background: rgba(0,180,216,0.12); color: var(--cyan-light); border: 1px solid rgba(0,180,216,0.2); }

/* â”€â”€ QUICK ACTIONS â”€â”€ */
.actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }

.action-btn {
  display: flex; flex-direction: column; align-items: center; gap: 0.5rem;
  padding: 1rem 0.75rem;
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); cursor: pointer;
  transition: all 0.2s; color: var(--text-2); font-family: inherit; font-size: 0.78rem; font-weight: 500;
}
.action-btn:hover { background: rgba(30,136,229,0.15); border-color: var(--blue); color: var(--blue-light); transform: translateY(-2px); }
.action-btn .icon { font-size: 1.4rem; }

/* â”€â”€ PROFILE â”€â”€ */
.profile-header {
  background: linear-gradient(135deg, var(--blue) 0%, var(--navy-3) 50%, var(--teal) 100%);
  padding: 2rem 2.5rem;
  border-radius: var(--radius);
  display: flex; gap: 1.5rem; align-items: center;
  margin-bottom: 1.5rem;
  position: relative; overflow: hidden;
}

.profile-header::before {
  content: '';
  position: absolute; top: -50%; right: -10%;
  width: 300px; height: 300px;
  background: rgba(255,255,255,0.04);
  border-radius: 50%;
}

.avatar-lg {
  width: 88px; height: 88px;
  border-radius: 18px;
  background: rgba(255,255,255,0.15);
  border: 2px solid rgba(255,255,255,0.25);
  font-size: 2.2rem;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; flex-shrink: 0;
  backdrop-filter: blur(8px);
}

.profile-info h2 { font-size: 1.6rem; font-weight: 800; margin-bottom: 0.25rem; }
.profile-info p { opacity: 0.85; font-size: 0.9rem; }

.profile-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;
}

.info-cell label {
  display: block; font-size: 0.68rem; font-weight: 700;
  text-transform: uppercase; color: var(--text-3); letter-spacing: 0.08em;
  margin-bottom: 0.35rem;
}
.info-cell span { font-size: 0.95rem; font-weight: 500; color: var(--text); }

/* â”€â”€ PATIENT REPORT MODAL â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; z-index: 9000;
  background: rgba(2,12,30,0.85); backdrop-filter: blur(8px);
  display: none; align-items: center; justify-content: center; padding: 1rem;
}
.modal-overlay.open { display: flex; animation: fadeUp 0.2s; }

.modal-box {
  background: var(--card);
  border: 1px solid var(--border-bright);
  border-radius: 20px;
  width: 100%; max-width: 800px; max-height: 90vh;
  display: flex; flex-direction: column;
  box-shadow: 0 40px 100px rgba(0,0,0,0.6);
}

.modal-head {
  padding: 1.25rem 1.75rem;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.modal-head h3 { font-size: 1.1rem; font-weight: 700; }
.modal-close {
  width: 32px; height: 32px; border-radius: 8px;
  background: var(--surface); border: none; color: var(--text-2);
  font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.modal-body { padding: 1.5rem 1.75rem; overflow-y: auto; flex: 1; }

.patient-visits-timeline { display: flex; flex-direction: column; gap: 1rem; }
.visit-entry {
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 1rem 1.25rem;
  position: relative;
}
.visit-entry::before {
  content: '';
  position: absolute; left: -1px; top: 0; bottom: 0; width: 3px;
  background: linear-gradient(var(--blue-bright), var(--cyan));
  border-radius: 2px;
}
.visit-num { font-size: 0.68rem; font-weight: 700; color: var(--blue-light); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem; }
.visit-date { font-size: 0.82rem; color: var(--text-3); font-family: monospace; }

/* â”€â”€ PATIENT DEMOGRAPHICS â”€â”€ */
.demo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.875rem; margin-bottom: 1.25rem; }
.demo-cell { background: var(--surface-2); border-radius: 8px; padding: 0.75rem; border: 1px solid var(--border); }
.demo-cell label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-3); letter-spacing: 0.08em; display: block; margin-bottom: 0.25rem; }
.demo-cell span { font-size: 0.88rem; font-weight: 600; color: var(--text); }

/* â”€â”€ COUNT BADGE â”€â”€ */
.count-badge {
  background: rgba(0,180,216,0.15); color: var(--cyan-light);
  border: 1px solid rgba(0,180,216,0.25);
  padding: 2px 10px; border-radius: 20px;
  font-size: 0.72rem; font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
}

/* â”€â”€ VISIT COUNT â”€â”€ */
.visit-count-badge {
  display: inline-flex; align-items: center; gap: 0.3rem;
  background: rgba(124,77,255,0.15); color: #b39ddb;
  border: 1px solid rgba(124,77,255,0.25);
  padding: 2px 8px; border-radius: 12px;
  font-size: 0.68rem; font-family: 'JetBrains Mono', monospace; font-weight: 600;
}

/* â”€â”€ BTN SECONDARY â”€â”€ */
.btn-sm {
  padding: 0.4rem 0.875rem;
  background: rgba(30,136,229,0.15); color: var(--blue-light);
  border: 1px solid rgba(30,136,229,0.25);
  border-radius: 6px; font-family: inherit; font-size: 0.78rem; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.btn-sm:hover { background: var(--blue); color: #fff; }

.btn-sm.outline {
  background: transparent; color: var(--blue-light);
  border: 1px solid rgba(30,136,229,0.3);
}
.btn-sm.outline:hover { background: rgba(30,136,229,0.15); }

.empty-state {
  padding: 3rem; text-align: center; color: var(--text-3); font-size: 0.9rem;
}
.empty-state .emoji { font-size: 2.5rem; display: block; margin-bottom: 0.75rem; }

.section-actions { display: flex; gap: 0.5rem; }

.link-btn {
  background: none; border: none; color: var(--blue-light);
  font-family: inherit; font-size: 0.85rem; cursor: pointer;
  text-decoration: underline; padding: 0;
}

/* â”€â”€ SERVICE REQ HIGHLIGHTED â”€â”€ */
.sr-highlight {
  background: rgba(0,180,216,0.08); border-color: rgba(0,180,216,0.2);
}

@media (max-width: 1100px) {
  .dashboard-grid { grid-template-columns: 1fr; }
}

@media (max-width: 900px) {
  .sidebar { width: 60px; }
  .sidebar .logo-text, .sidebar .logo-sub, .sidebar .nav-item span, .sidebar .nav-group-label, .sidebar .user-name, .sidebar .user-role, .sidebar .btn-logout span { display: none; }
  .sidebar .nav-item { justify-content: center; padding: 0.65rem 0; }
  .main-content { margin-left: 60px; }
  .profile-grid { grid-template-columns: 1fr; }
  .demo-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<!-- â”€â”€ ACCESS OVERLAY â”€â”€ -->
<div id="access-overlay" class="overlay">
  <div class="overlay-card">
    <div class="overlay-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    </div>
    <h2 id="overlay-title">Sneha Health</h2>
    <p id="overlay-status">Verifying your sessionâ€¦</p>

    <div id="manual-picker" class="hidden" style="margin-top:1.5rem;text-align:left;">
      <p style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.5rem;">Select your practitioner profile:</p>
      <div id="picker-list" class="picker-list"></div>
    </div>

    <div id="login-form-view" class="login-form hidden">
      <div id="login-error" style="color:var(--red);font-size:0.8rem;margin-bottom:0.75rem;text-align:center;display:none;"></div>
      <label>Email</label><input type="text" id="login-user" placeholder="doctor@snehahealth.com">
      <label>Password</label><input type="password" id="login-pass">
      <button class="btn-primary" onclick="handleLogin()">Sign In â†’</button>
    </div>

    <div class="diag" id="diag-log"></div>
  </div>
</div>

<!-- â”€â”€ PATIENT REPORT MODAL â”€â”€ -->
<div class="modal-overlay" id="patient-modal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>ğŸ©º Patient Report</h3>
      <button class="modal-close" onclick="closePatientModal()">âœ•</button>
    </div>
    <div class="modal-body" id="patient-modal-body">Loadingâ€¦</div>
  </div>
</div>

<!-- â”€â”€ APP SHELL â”€â”€ -->
<div id="app-shell" class="app-shell hidden">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" width="20" height="20"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <div>
        <div class="logo-text">Sneha Health</div>
        <div class="logo-sub">Doctor Portal</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-item active" data-section="dashboard"><span class="nav-icon">ğŸ </span><span>Dashboard</span></div>
      <div class="nav-item" data-section="profile"><span class="nav-icon">ğŸ‘¤</span><span>My Profile</span></div>

      <div class="nav-group-label">Clinical</div>
      <div class="nav-item" data-section="patients"><span class="nav-icon">ğŸ§‘â€âš•ï¸</span><span>My Patients</span></div>
      <div class="nav-item" data-section="encounters"><span class="nav-icon">ğŸ“‹</span><span>Encounters</span></div>
      <div class="nav-item" data-section="servicereq"><span class="nav-icon">ğŸ“</span><span>Service Requests</span></div>
      <div class="nav-item" data-section="therapy"><span class="nav-icon">ğŸƒ</span><span>Therapy Plans</span></div>

      <div class="nav-group-label">HR</div>
      <div class="nav-item" data-section="attendance"><span class="nav-icon">ğŸ•’</span><span>Attendance</span></div>
      <div class="nav-item" data-section="leave"><span class="nav-icon">ğŸŒ´</span><span>Leave</span></div>
      <div class="nav-item" data-section="payroll"><span class="nav-icon">ğŸ’°</span><span>Payroll</span></div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-card">
        <div class="avatar" id="nav-avatar">?</div>
        <div>
          <div class="user-name" id="nav-name">Loadingâ€¦</div>
          <div class="user-role" id="nav-role">Practitioner</div>
        </div>
      </div>
      <button class="btn-logout" id="btn-logout">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        <span>Sign Out</span>
      </button>
    </div>
  </aside>

  <main class="main-content">
    <header class="top-header">
      <h2 class="page-title" id="page-title">Dashboard</h2>
      <div class="header-right">
        <div class="date-chip" id="date-chip">â€”</div>
        <button class="btn-sm" onclick="window.open(BASE+'/app', '_blank')">Open ERPNext â†—</button>
      </div>
    </header>

    <div id="prac-warning-banner" class="prac-banner hidden">
      <p>âš  Practitioner profile not linked â€” clinical sections are locked.</p>
      <button onclick="showPicker()">Link Now</button>
    </div>

    <div class="content-body">

      <!-- DASHBOARD -->
      <section id="section-dashboard" class="section active">
        <div class="stats-grid">
          <div class="stat-card blue">
            <div class="stat-icon">ğŸ“…</div>
            <div><div class="stat-label">Today's Appointments</div><div class="stat-value" id="stat-appts">â€”</div></div>
          </div>
          <div class="stat-card green">
            <div class="stat-icon">âœ…</div>
            <div><div class="stat-label">Completed</div><div class="stat-value" id="stat-done">â€”</div></div>
          </div>
          <div class="stat-card amber">
            <div class="stat-icon">ğŸ•’</div>
            <div><div class="stat-label">Attendance</div><div class="stat-value" id="stat-att">â€”</div></div>
          </div>
          <div class="stat-card cyan">
            <div class="stat-icon">ğŸ‘¥</div>
            <div><div class="stat-label">Total Patients</div><div class="stat-value" id="stat-patients">â€”</div></div>
          </div>
          <div class="stat-card purple">
            <div class="stat-icon">ğŸ“</div>
            <div><div class="stat-label">Service Requests</div><div class="stat-value" id="stat-sr">â€”</div></div>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Today's Schedule</h3>
              <div class="badge badge-info" id="today-label">â€”</div>
            </div>
            <div class="card-body" id="list-schedule">
              <div class="empty-state"><span class="emoji">ğŸ“…</span>Loading scheduleâ€¦</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3 class="card-title">Quick Actions</h3></div>
            <div class="card-body">
              <div class="actions-grid">
                <button class="action-btn" onclick="openERP('/app/patient-appointment/new')"><span class="icon">ğŸ“…</span>New Appt</button>
                <button class="action-btn" onclick="openERP('/app/patient-encounter/new')"><span class="icon">ğŸ“‹</span>Encounter</button>
                <button class="action-btn" onclick="openERP('/app/service-request/new')"><span class="icon">ğŸ“</span>Svc Request</button>
                <button class="action-btn" onclick="openERP('/app/leave-application/new')"><span class="icon">ğŸŒ´</span>Leave</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Service Requests</h3>
            <button class="btn-sm" onclick="switchSection('servicereq')">View All</button>
          </div>
          <div class="card-body" id="list-dash-sr">
            <div class="empty-state"><span class="emoji">ğŸ“</span>Loadingâ€¦</div>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="section-profile" class="section">
        <div id="profile-container"><div class="empty-state">Loadingâ€¦</div></div>
      </section>

      <!-- MY PATIENTS -->
      <section id="section-patients" class="section">
        <div class="card">
          <div class="card-header">
            <div style="display:flex;align-items:center;gap:0.75rem;">
              <h3 class="card-title">My Patients</h3>
              <span class="count-badge" id="count-patients">0</span>
            </div>
            <button class="btn-sm" onclick="openERP('/app/patient/new')">+ New Patient</button>
          </div>
          <div class="card-body" id="list-patients">
            <div class="empty-state"><span class="emoji">ğŸ§‘â€âš•ï¸</span>Loadingâ€¦</div>
          </div>
        </div>
      </section>

      <!-- ENCOUNTERS -->
      <section id="section-encounters" class="section">
        <div class="card">
          <div class="card-header">
            <div style="display:flex;align-items:center;gap:0.75rem;">
              <h3 class="card-title">Patient Encounters</h3>
              <span class="count-badge" id="count-encounters">0</span>
            </div>
            <button class="btn-sm" onclick="openERP('/app/patient-encounter/new')">+ New</button>
          </div>
          <div class="card-body" id="list-encounters">
            <div class="empty-state"><span class="emoji">ğŸ“‹</span>Loadingâ€¦</div>
          </div>
        </div>
      </section>

      <!-- SERVICE REQUESTS -->
      <section id="section-servicereq" class="section">
        <div class="card">
          <div class="card-header">
            <div style="display:flex;align-items:center;gap:0.75rem;">
              <h3 class="card-title">Service Requests</h3>
              <span class="count-badge" id="count-sr">0</span>
            </div>
            <div class="section-actions">
              <button class="btn-sm" onclick="openERP('/app/service-request/new')">+ New Request</button>
            </div>
          </div>
          <div class="card-body" id="list-servicereq">
            <div class="empty-state"><span class="emoji">ğŸ“</span>Loadingâ€¦</div>
          </div>
        </div>
      </section>

      <!-- THERAPY -->
      <section id="section-therapy" class="section">
        <div class="card">
          <div class="card-header">
            <div style="display:flex;align-items:center;gap:0.75rem;">
              <h3 class="card-title">Therapy Plans & Sessions</h3>
              <span class="count-badge" id="count-therapy">0</span>
            </div>
            <div class="section-actions">
              <button class="btn-sm outline" onclick="openERP('/app/therapy-plan/new')">+ Plan</button>
              <button class="btn-sm" onclick="openERP('/app/therapy-session/new')">+ Session</button>
            </div>
          </div>
          <div class="card-body" id="list-therapy">
            <div class="empty-state"><span class="emoji">ğŸƒ</span>Loadingâ€¦</div>
          </div>
        </div>
      </section>

      <!-- ATTENDANCE -->
      <section id="section-attendance" class="section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Attendance Record</h3>
            <button class="btn-sm" onclick="openERP('/app/attendance/new')">+ Mark</button>
          </div>
          <div class="card-body" id="list-attendance"><div class="empty-state">Loadingâ€¦</div></div>
        </div>
      </section>

      <!-- LEAVE -->
      <section id="section-leave" class="section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Leave Applications</h3>
            <button class="btn-sm" onclick="openERP('/app/leave-application/new')">+ Apply</button>
          </div>
          <div class="card-body" id="list-leave"><div class="empty-state">Loadingâ€¦</div></div>
        </div>
      </section>

      <!-- PAYROLL -->
      <section id="section-payroll" class="section">
        <div class="card">
          <div class="card-header"><h3 class="card-title">Salary Slips</h3></div>
          <div class="card-body" id="list-payroll"><div class="empty-state">Loadingâ€¦</div></div>
        </div>
      </section>

    </div><!-- /content-body -->
  </main>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONFIGURATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const BASE = window.location.origin;
const HC_FIELDS = ['name', 'practitioner_name', 'designation', 'department', 'employee', 'user_id'];

let state = {
  user: null,
  practitioner: null,
  employee: null,
  activeSection: 'dashboard'
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UTILITIES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function log(msg, type = 'info') {
  const el = document.getElementById('diag-log');
  if (el) {
    const d = document.createElement('div');
    d.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#69db7c' : '#748ffc';
    d.textContent = `${type === 'error' ? 'âœ—' : 'âœ“'} ${msg}`;
    el.appendChild(d); el.scrollTop = el.scrollHeight;
  }
}

function badgeClass(status) {
  if (!status) return 'badge-info';
  const s = status.toLowerCase();
  if (['completed','present','approved','active','closed','submitted','paid'].some(x => s.includes(x))) return 'badge-success';
  if (['cancelled','rejected','absent'].some(x => s.includes(x))) return 'badge-error';
  if (['pending','open','draft','waiting','scheduled'].some(x => s.includes(x))) return 'badge-warn';
  return 'badge-info';
}

function fmt(str) {
  if (!str) return 'â€”';
  if (str.match(/^\d{4}-\d{2}-\d{2}/)) {
    const d = new Date(str);
    return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
  }
  return str;
}

function openERP(path) { window.open(BASE + path, '_blank'); }

function empty(msg = 'No records found.') {
  return `<div class="empty-state"><span class="emoji">ğŸ“­</span>${msg}</div>`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   API
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function api(resource, params = {}) {
  const url = new URL(`${BASE}/api/resource/${encodeURIComponent(resource)}`);
  if (params.filters) url.searchParams.set('filters', JSON.stringify(params.filters));
  if (params.fields) url.searchParams.set('fields', JSON.stringify(params.fields));
  if (params.limit) url.searchParams.set('limit', params.limit);
  if (params.order_by) url.searchParams.set('order_by', params.order_by);
  try {
    const r = await fetch(url, { credentials: 'include' });
    if (r.ok) return (await r.json())?.data || [];
    return null;
  } catch (e) { return null; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SESSION & DISCOVERY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function initSession() {
  log('Initializing sessionâ€¦');
  try {
    const r = await fetch('/api/method/frappe.auth.get_logged_user');
    const user = (await r.json())?.message;
    if (!user || user === 'Guest') { showLoginUI(); return; }
    state.user = user;
    log(`Session: ${user}`, 'success');
    await runDiscovery();
  } catch (e) { showLoginUI(); }
}

async function runDiscovery() {
  log('Discovering profilesâ€¦');

  // Employee
  const emp = await api('Employee', {
    filters: [['user_id', '=', state.user]],
    fields: ['name', 'employee_name', 'designation', 'department', 'cell_number', 'personal_email']
  });
  if (emp?.length) { state.employee = emp[0]; log(`Employee: ${emp[0].name}`, 'success'); }

  // Practitioner â€” try multiple strategies
  let pRes = null;

  pRes = await api('Healthcare Practitioner', { filters: [['user_id', '=', state.user]], fields: HC_FIELDS });
  if (!pRes?.length && state.employee)
    pRes = await api('Healthcare Practitioner', { filters: [['employee', '=', state.employee.name]], fields: HC_FIELDS });
  if (!pRes?.length) {
    const q = (state.employee?.employee_name || state.user).split(' ')[0];
    pRes = await api('Healthcare Practitioner', { filters: [['practitioner_name', 'like', `%${q}%`]], fields: HC_FIELDS });
  }
  const savedId = localStorage.getItem('dr_prac_id');
  if (!pRes?.length && savedId)
    pRes = await api('Healthcare Practitioner', { filters: [['name', '=', savedId]], fields: HC_FIELDS });

  if (pRes?.length) {
    state.practitioner = pRes[0];
    localStorage.setItem('dr_prac_id', pRes[0].name);
    log(`Practitioner: ${pRes[0].practitioner_name}`, 'success');
  } else {
    log('Practitioner not found â€” manual link needed.', 'error');
    showPicker();
  }

  launchApp();
}

function showLoginUI() {
  document.getElementById('overlay-title').textContent = 'Doctor Login';
  document.getElementById('overlay-status').textContent = '';
  document.getElementById('login-form-view').classList.remove('hidden');
}

async function handleLogin() {
  const usr = document.getElementById('login-user').value;
  const pwd = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-error');
  try {
    const r = await fetch('/api/method/login', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usr, pwd })
    });
    if (r.ok) window.location.reload();
    else { errEl.textContent = 'Invalid credentials.'; errEl.style.display = 'block'; }
  } catch (e) { errEl.textContent = 'Connection error.'; errEl.style.display = 'block'; }
}

async function showPicker() {
  const pickerEl = document.getElementById('manual-picker');
  pickerEl.classList.remove('hidden');
  const listEl = document.getElementById('picker-list');
  listEl.innerHTML = '<div class="picker-item" style="color:var(--text-3)">Loadingâ€¦</div>';
  const all = await api('Healthcare Practitioner', { fields: ['name', 'practitioner_name', 'department'], limit: 200 });
  if (all?.length) {
    listEl.innerHTML = all.map(p => `
      <div class="picker-item" onclick="linkPrac('${p.name}')">
        ${p.practitioner_name || p.name}
        <div class="pid">${p.name} Â· ${p.department || 'â€”'}</div>
      </div>`).join('');
  } else {
    listEl.innerHTML = '<div class="picker-item" style="color:var(--text-3);font-size:0.8rem;">No practitioners found. Check permissions.</div>';
  }
}

function linkPrac(id) {
  localStorage.setItem('dr_prac_id', id);
  window.location.reload();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   APP LAUNCH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function launchApp() {
  document.getElementById('access-overlay').classList.add('hidden');
  document.getElementById('app-shell').classList.remove('hidden');

  const name = state.practitioner?.practitioner_name || state.employee?.employee_name || state.user;
  const role = state.practitioner?.department || state.employee?.designation || 'Practitioner';

  document.getElementById('nav-name').textContent = name;
  document.getElementById('nav-role').textContent = role;
  document.getElementById('nav-avatar').textContent = name.charAt(0).toUpperCase();
  document.getElementById('date-chip').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
  document.getElementById('today-label').textContent = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long' });

  if (!state.practitioner) document.getElementById('prac-warning-banner').classList.remove('hidden');

  initNav();
  switchSection('dashboard');
}

function initNav() {
  document.querySelectorAll('.nav-item').forEach(item => {
    item.onclick = () => {
      if (item.classList.contains('nav-locked')) return;
      const s = item.dataset.section;
      if (s) switchSection(s);
    };
  });
  document.getElementById('btn-logout').onclick = () => {
    localStorage.removeItem('dr_prac_id');
    fetch('/api/method/logout', { method: 'POST' }).finally(() => window.location.reload());
  };
}

function switchSection(id) {
  state.activeSection = id;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.section === id));
  document.querySelectorAll('.section').forEach(s => s.classList.toggle('active', s.id === `section-${id}`));
  const titles = {
    dashboard: 'Dashboard', profile: 'My Profile', patients: 'My Patients',
    encounters: 'Patient Encounters', servicereq: 'Service Requests',
    therapy: 'Therapy Plans', attendance: 'Attendance', leave: 'Leave', payroll: 'Payroll'
  };
  document.getElementById('page-title').textContent = titles[id] || id;
  loadSection(id);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOADERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSection(id) {
  if (id === 'dashboard') { loadDashboard(); return; }
  if (id === 'profile') { loadProfile(); return; }

  const bodyEl = document.getElementById(`list-${id}`);
  const p = state.practitioner?.name;
  const e = state.employee?.name;

  // â”€â”€ MY PATIENTS â”€â”€
  if (id === 'patients') {
    if (!p) { bodyEl.innerHTML = empty('Practitioner not linked.'); return; }
    bodyEl.innerHTML = '<div class="empty-state">Loadingâ€¦</div>';
    const appts = await api('Patient Appointment', {
      filters: [['practitioner', '=', p]],
      fields: ['patient', 'patient_name', 'appointment_date', 'status'],
      limit: 500
    });
    if (!appts?.length) { bodyEl.innerHTML = empty('No patients found.'); return; }

    // Unique patients with visit count
    const patMap = {};
    appts.forEach(a => {
      if (!patMap[a.patient]) patMap[a.patient] = { name: a.patient, patient_name: a.patient_name, visits: 0, last_date: a.appointment_date };
      patMap[a.patient].visits++;
      if (a.appointment_date > patMap[a.patient].last_date) patMap[a.patient].last_date = a.appointment_date;
    });
    const unique = Object.values(patMap).sort((a, b) => b.last_date.localeCompare(a.last_date));
    document.getElementById('count-patients').textContent = unique.length;

    bodyEl.innerHTML = unique.map(pt => `
      <div class="data-row" onclick="openPatientReport('${pt.name}', '${(pt.patient_name||'').replace(/'/g,"\\'")}')">
        <div class="row-info">
          <b>${pt.patient_name || pt.name}</b>
          <span>Last visit: ${fmt(pt.last_date)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:0.5rem;">
          <span class="visit-count-badge">ğŸ‘ ${pt.visits} visit${pt.visits !== 1 ? 's' : ''}</span>
          <span class="row-arrow">â†—</span>
        </div>
      </div>`).join('');
    return;
  }

  // â”€â”€ ENCOUNTERS â”€â”€
  if (id === 'encounters') {
    if (!p) { bodyEl.innerHTML = empty('Practitioner not linked.'); return; }
    bodyEl.innerHTML = '<div class="empty-state">Loadingâ€¦</div>';
    const data = await api('Patient Encounter', {
      filters: [['practitioner', '=', p]],
      fields: ['name', 'patient', 'patient_name', 'encounter_date', 'status'],
      order_by: 'encounter_date desc', limit: 100
    });
    if (!data?.length) { bodyEl.innerHTML = empty('No encounters found.'); return; }
    document.getElementById('count-encounters').textContent = data.length;
    bodyEl.innerHTML = data.map(i => `
      <div class="data-row" onclick="openERP('/app/patient-encounter/${i.name}')">
        <div class="row-info">
          <b>${i.patient_name || i.patient || 'â€”'}</b>
          <span>${fmt(i.encounter_date)} Â· ${i.name}</span>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <span class="badge ${badgeClass(i.status)}">${i.status || 'Draft'}</span>
          <span class="row-arrow">â†—</span>
        </div>
      </div>`).join('');
    return;
  }

  // â”€â”€ SERVICE REQUESTS â”€â”€
  if (id === 'servicereq') {
    if (!p) { bodyEl.innerHTML = empty('Practitioner not linked.'); return; }
    bodyEl.innerHTML = '<div class="empty-state">Loadingâ€¦</div>';
    let data = await api('Service Request', {
      filters: [['ordered_by', '=', p]],
      fields: ['name', 'patient', 'status', 'order_date', 'patient_care_type', 'ordered_by', 'template_dt'],
      order_by: 'creation desc', limit: 100
    });
    if (!data?.length) {
      data = await api('Service Request', {
        filters: [['practitioner', '=', p]],
        fields: ['name', 'patient', 'status', 'order_date', 'patient_care_type', 'ordered_by', 'template_dt'],
        order_by: 'creation desc', limit: 100
      });
    }
    if (!data?.length) { bodyEl.innerHTML = empty('No service requests found.'); return; }
    document.getElementById('count-sr').textContent = data.length;
    bodyEl.innerHTML = data.map(i => `
      <div class="data-row sr-highlight" onclick="openERP('/app/service-request/${i.name}')">
        <div class="row-info">
          <b>${i.patient || i.name}</b>
          <span>
            ${i.patient_care_type || 'Service Request'} Â· ${fmt(i.order_date)}
            ${i.template_dt ? `Â· <span style="color:var(--cyan-light);font-family:monospace;font-size:0.72rem;">${i.template_dt}</span>` : ''}
          </span>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <span class="badge ${badgeClass(i.status)}">${i.status || 'Pending'}</span>
          <span class="row-arrow">â†—</span>
        </div>
      </div>`).join('');
    return;
  }

  // â”€â”€ THERAPY â”€â”€
  if (id === 'therapy') {
    if (!p) { bodyEl.innerHTML = empty('Practitioner not linked.'); return; }
    bodyEl.innerHTML = '<div class="empty-state">Loadingâ€¦</div>';
    const [plans, sessions] = await Promise.all([
      api('Therapy Plan', { filters: [['practitioner', '=', p]], fields: ['name', 'patient', 'patient_name', 'status', 'start_date', 'total_sessions', 'sessions_completed'], limit: 100, order_by: 'creation desc' }),
      api('Therapy Session', { filters: [['practitioner', '=', p]], fields: ['name', 'patient', 'patient_name', 'status', 'start_date', 'therapy_type'], limit: 100, order_by: 'creation desc' })
    ]);
    const total = (plans?.length || 0) + (sessions?.length || 0);
    document.getElementById('count-therapy').textContent = total;

    let html = '';
    if (plans?.length) {
      html += `<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;color:var(--blue-light);margin-bottom:0.75rem;letter-spacing:1px;">ğŸ“‹ THERAPY PLANS</div>`;
      html += plans.map(i => `
        <div class="data-row" onclick="openERP('/app/therapy-plan/${i.name}')">
          <div class="row-info">
            <b>${i.patient_name || i.patient || i.name}</b>
            <span>Sessions: ${i.sessions_completed || 0}/${i.total_sessions || '?'} Â· Start: ${fmt(i.start_date)}</span>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <span class="badge ${badgeClass(i.status)}">${i.status || 'Active'}</span>
            <span class="row-arrow">â†—</span>
          </div>
        </div>`).join('');
    }
    if (sessions?.length) {
      html += `<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;color:var(--cyan-light);margin:1.25rem 0 0.75rem;letter-spacing:1px;">ğŸƒ THERAPY SESSIONS</div>`;
      html += sessions.map(i => `
        <div class="data-row" onclick="openERP('/app/therapy-session/${i.name}')">
          <div class="row-info">
            <b>${i.patient_name || i.patient || i.name}</b>
            <span>${i.therapy_type || 'Session'} Â· ${fmt(i.start_date)}</span>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <span class="badge ${badgeClass(i.status)}">${i.status || 'Scheduled'}</span>
            <span class="row-arrow">â†—</span>
          </div>
        </div>`).join('');
    }
    bodyEl.innerHTML = html || empty('No therapy data found.');
    return;
  }

  // â”€â”€ ATTENDANCE â”€â”€
  if (id === 'attendance') {
    if (!e) { bodyEl.innerHTML = empty('Employee not linked.'); return; }
    const data = await api('Attendance', {
      filters: [['employee', '=', e]],
      fields: ['name', 'attendance_date', 'status', 'in_time', 'out_time'],
      limit: 60, order_by: 'attendance_date desc'
    });
    if (!data?.length) { bodyEl.innerHTML = empty('No attendance records.'); return; }
    bodyEl.innerHTML = data.map(i => `
      <div class="data-row" onclick="openERP('/app/attendance/${i.name}')">
        <div class="row-info">
          <b>${fmt(i.attendance_date)}</b>
          <span>${i.in_time ? 'ğŸŸ¢ ' + i.in_time.substring(0,5) : ''} ${i.out_time ? ' Â· ğŸ”´ ' + i.out_time.substring(0,5) : ''}</span>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <span class="badge ${badgeClass(i.status)}">${i.status || 'â€”'}</span>
          <span class="row-arrow">â†—</span>
        </div>
      </div>`).join('');
    return;
  }

  // â”€â”€ LEAVE â”€â”€
  if (id === 'leave') {
    if (!e) { bodyEl.innerHTML = empty('Employee not linked.'); return; }
    const data = await api('Leave Application', {
      filters: [['employee', '=', e]],
      fields: ['name', 'leave_type', 'from_date', 'to_date', 'status', 'total_leave_days'],
      limit: 30, order_by: 'from_date desc'
    });
    if (!data?.length) { bodyEl.innerHTML = empty('No leave applications.'); return; }
    bodyEl.innerHTML = data.map(i => `
      <div class="data-row" onclick="openERP('/app/leave-application/${i.name}')">
        <div class="row-info">
          <b>${i.leave_type}</b>
          <span>${fmt(i.from_date)} â†’ ${fmt(i.to_date)} Â· ${i.total_leave_days || '?'} day(s)</span>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <span class="badge ${badgeClass(i.status)}">${i.status}</span>
          <span class="row-arrow">â†—</span>
        </div>
      </div>`).join('');
    return;
  }

  // â”€â”€ PAYROLL â”€â”€
  if (id === 'payroll') {
    if (!e) { bodyEl.innerHTML = empty('Employee not linked.'); return; }
    const data = await api('Salary Slip', {
      filters: [['employee', '=', e]],
      fields: ['name', 'start_date', 'end_date', 'net_pay', 'currency', 'status'],
      limit: 24, order_by: 'start_date desc'
    });
    if (!data?.length) { bodyEl.innerHTML = empty('No salary slips.'); return; }
    bodyEl.innerHTML = data.map(i => `
      <div class="data-row" onclick="window.open('${BASE}/printview?doctype=Salary%20Slip&name=${encodeURIComponent(i.name)}&format=Salary%20Slip', '_blank')">
        <div class="row-info">
          <b>${fmt(i.start_date)} â€“ ${fmt(i.end_date)}</b>
          <span>Net Pay: ${i.currency || 'â‚¹'} ${Number(i.net_pay || 0).toLocaleString('en-IN')}</span>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <span class="badge ${badgeClass(i.status)}">${i.status || 'View'}</span>
          <span class="row-arrow">â†—</span>
        </div>
      </div>`).join('');
    return;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DASHBOARD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadDashboard() {
  const today = new Date().toISOString().split('T')[0];
  const p = state.practitioner?.name;
  const e = state.employee?.name;

  // Appointments
  if (p) {
    const appts = await api('Patient Appointment', {
      filters: [['practitioner', '=', p], ['appointment_date', '=', today]],
      fields: ['name', 'patient_name', 'appointment_time', 'status'],
      order_by: 'appointment_time asc'
    });
    document.getElementById('stat-appts').textContent = appts?.length || 0;
    document.getElementById('stat-done').textContent = appts?.filter(a => ['Closed', 'Completed'].includes(a.status)).length || 0;

    const listEl = document.getElementById('list-schedule');
    if (appts?.length) {
      listEl.innerHTML = appts.map(a => `
        <div class="data-row" onclick="openERP('/app/patient-appointment/${a.name}')">
          <div class="row-info">
            <b>${a.patient_name}</b>
            <span>â° ${a.appointment_time || 'â€”'}</span>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <span class="badge ${badgeClass(a.status)}">${a.status}</span>
            <span class="row-arrow">â†—</span>
          </div>
        </div>`).join('');
    } else { listEl.innerHTML = empty('No appointments today.'); }

    // Total patients
    const allAppts = await api('Patient Appointment', { filters: [['practitioner', '=', p]], fields: ['patient'], limit: 1000 });
    const uniquePats = new Set(allAppts?.map(a => a.patient) || []);
    document.getElementById('stat-patients').textContent = uniquePats.size;

    // Service requests count
    const srData = await api('Service Request', { filters: [['ordered_by', '=', p]], fields: ['name', 'patient', 'status', 'order_date', 'patient_care_type', 'template_dt'], limit: 100 });
    document.getElementById('stat-sr').textContent = srData?.length || 0;
    const dashSrEl = document.getElementById('list-dash-sr');
    if (srData?.length) {
      dashSrEl.innerHTML = srData.slice(0, 5).map(i => `
        <div class="data-row sr-highlight" onclick="openERP('/app/service-request/${i.name}')">
          <div class="row-info">
            <b>${i.patient || i.name}</b>
            <span>${i.patient_care_type || 'Service Request'} ${i.template_dt ? 'Â· ' + i.template_dt : ''} Â· ${fmt(i.order_date)}</span>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <span class="badge ${badgeClass(i.status)}">${i.status || 'Pending'}</span>
            <span class="row-arrow">â†—</span>
          </div>
        </div>`).join('');
    } else { dashSrEl.innerHTML = empty('No service requests.'); }
  }

  // Attendance
  if (e) {
    const att = await api('Attendance', {
      filters: [['employee', '=', e], ['attendance_date', '=', today]],
      fields: ['status']
    });
    document.getElementById('stat-att').textContent = att?.[0]?.status || 'Not Marked';
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PROFILE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadProfile() {
  const c = document.getElementById('profile-container');
  const p = state.practitioner;
  const e = state.employee;
  const name = p?.practitioner_name || e?.employee_name || state.user;

  c.innerHTML = `
    <div class="profile-header">
      <div class="avatar-lg">${name.charAt(0).toUpperCase()}</div>
      <div class="profile-info">
        <h2>${name}</h2>
        <p>${p?.department || e?.designation || 'Healthcare Practitioner'}</p>
        ${!p ? `<button onclick="showPicker()" style="margin-top:0.75rem;padding:0.4rem 1rem;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:6px;color:white;cursor:pointer;font-size:0.8rem;">ğŸ”— Link Practitioner</button>` : ''}
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h3 class="card-title">Profile Details</h3></div>
      <div class="card-body">
        <div class="profile-grid">
          <div class="info-cell"><label>Practitioner ID</label><span>${p?.name || 'â€”'}</span></div>
          <div class="info-cell"><label>Employee ID</label><span>${e?.name || 'â€”'}</span></div>
          <div class="info-cell"><label>Department</label><span>${p?.department || e?.department || 'â€”'}</span></div>
          <div class="info-cell"><label>Email</label><span>${e?.personal_email || state.user}</span></div>
          <div class="info-cell"><label>Designation</label><span>${e?.designation || p?.designation || 'â€”'}</span></div>
          <div class="info-cell"><label>Mobile</label><span>${e?.cell_number || 'â€”'}</span></div>
        </div>
      </div>
    </div>`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PATIENT REPORT MODAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function openPatientReport(patId, patName) {
  document.getElementById('patient-modal').classList.add('open');
  const body = document.getElementById('patient-modal-body');
  body.innerHTML = '<div class="empty-state">Loading patient dataâ€¦</div>';

  const [patDoc, encounters, appts] = await Promise.all([
    api('Patient', { filters: [['name', '=', patId]], fields: ['name', 'patient_name', 'sex', 'dob', 'blood_group', 'mobile', 'email', 'status', 'customer'], limit: 1 }),
    api('Patient Encounter', { filters: [['patient', '=', patId]], fields: ['name', 'encounter_date', 'status', 'diagnosis', 'practitioner'], order_by: 'encounter_date desc', limit: 100 }),
    api('Patient Appointment', { filters: [['patient', '=', patId]], fields: ['name', 'appointment_date', 'appointment_time', 'status', 'practitioner', 'department'], order_by: 'appointment_date desc', limit: 100 })
  ]);

  const pt = patDoc?.[0] || {};
  const visitCount = appts?.length || 0;

  let html = `
    <div class="demo-grid">
      <div class="demo-cell"><label>Patient Name</label><span>${pt.patient_name || patName || 'â€”'}</span></div>
      <div class="demo-cell"><label>Gender</label><span>${pt.sex || 'â€”'}</span></div>
      <div class="demo-cell"><label>Date of Birth</label><span>${fmt(pt.dob) || 'â€”'}</span></div>
      <div class="demo-cell"><label>Blood Group</label><span>${pt.blood_group || 'â€”'}</span></div>
      <div class="demo-cell"><label>Mobile</label><span>${pt.mobile || 'â€”'}</span></div>
      <div class="demo-cell"><label>Email</label><span>${pt.email || 'â€”'}</span></div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
      <h4 style="font-size:0.95rem;font-weight:700;">Visit History <span class="visit-count-badge" style="margin-left:0.5rem;">ğŸ‘ ${visitCount} visits</span></h4>
      <button class="btn-sm" onclick="openERP('/app/patient/${patId}')">Open Full Record â†—</button>
    </div>`;

  if (encounters?.length) {
    html += `<div class="patient-visits-timeline">`;
    encounters.forEach((enc, idx) => {
      html += `
        <div class="visit-entry">
          <div class="visit-num">Visit #${encounters.length - idx} â€” ${idx === 0 ? 'ğŸ†• Latest' : idx === encounters.length - 1 ? 'ğŸ¥ First Visit' : 'Follow-up'}</div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
            <div class="visit-date">${fmt(enc.encounter_date)}</div>
            <span class="badge ${badgeClass(enc.status)}">${enc.status || 'Draft'}</span>
          </div>
          <button class="btn-sm" onclick="openERP('/app/patient-encounter/${enc.name}')">View Encounter â†—</button>
        </div>`;
    });
    html += `</div>`;
  } else {
    html += `<div class="empty-state"><span class="emoji">ğŸ“‹</span>No clinical encounters recorded.</div>`;
  }

  if (appts?.length) {
    html += `<h4 style="font-size:0.9rem;font-weight:700;margin:1.25rem 0 0.75rem;color:var(--text-2);">Appointment History</h4>
    <div class="patient-visits-timeline">`;
    appts.slice(0, 10).forEach((a, idx) => {
      html += `
        <div class="visit-entry" style="padding:0.75rem 1rem;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <span class="visit-count-badge" style="margin-right:0.5rem;">Appt #${appts.length - idx}</span>
              <span class="visit-date">${fmt(a.appointment_date)} ${a.appointment_time ? 'Â· ' + a.appointment_time : ''}</span>
            </div>
            <span class="badge ${badgeClass(a.status)}">${a.status}</span>
          </div>
        </div>`;
    });
    html += `</div>`;
  }

  body.innerHTML = html;
}

function closePatientModal() {
  document.getElementById('patient-modal').classList.remove('open');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', initSession);
</script>
</body>
</html>
