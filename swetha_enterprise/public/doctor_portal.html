<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doctor Portal ‚Äî Rena Rehabilitation Centre</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --navy-900: #050d1a;
  --navy-800: #0a1628;
  --navy-700: #0d1f3c;
  --navy-600: #112850;
  --blue-500: #1a56db;
  --blue-400: #3b82f6;
  --blue-300: #60a5fa;
  --blue-200: #93c5fd;
  --blue-100: #dbeafe;
  --steel: #1e3a5f;
  --steel-light: #2d5282;
  --accent: #0ea5e9;
  --accent-glow: rgba(14,165,233,0.3);
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --text-primary: #f0f6ff;
  --text-secondary: #94b8d8;
  --text-muted: #5a7fa8;
  --card-bg: rgba(13,31,60,0.7);
  --card-border: rgba(59,130,246,0.15);
  --sidebar-w: 260px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--navy-900);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 20% 10%, rgba(26,86,219,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(14,165,233,0.08) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* SIDEBAR */
.sidebar {
  position: fixed;
  top: 0; left: 0;
  width: var(--sidebar-w);
  height: 100vh;
  background: linear-gradient(180deg, var(--navy-800) 0%, var(--navy-900) 100%);
  border-right: 1px solid var(--card-border);
  display: flex;
  flex-direction: column;
  z-index: 100;
  overflow-y: auto;
}
.sidebar-brand {
  padding: 24px 20px 20px;
  border-bottom: 1px solid var(--card-border);
}
.brand-logo {
  width: 42px; height: 42px;
  background: linear-gradient(135deg, var(--blue-500), var(--accent));
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  margin-bottom: 10px;
  box-shadow: 0 4px 16px var(--accent-glow);
}
.brand-name {
  font-family: 'Sora', sans-serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.3;
}
.brand-sub {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 2px;
}
.doctor-info {
  padding: 16px 20px;
  background: rgba(26,86,219,0.08);
  margin: 12px;
  border-radius: 10px;
  border: 1px solid var(--card-border);
}
.doctor-avatar {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--steel), var(--blue-500));
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  margin-bottom: 8px;
}
.doctor-name {
  font-family: 'Sora', sans-serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}
.doctor-role {
  font-size: 11px;
  color: var(--accent);
  display: flex; align-items: center; gap: 4px;
  margin-top: 2px;
}
.nav-section {
  padding: 8px 12px 4px;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 16px 9px 20px;
  margin: 1px 8px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13.5px;
  color: var(--text-secondary);
  transition: all 0.18s ease;
  text-decoration: none;
}
.nav-item:hover { background: rgba(59,130,246,0.1); color: var(--text-primary); }
.nav-item.active { background: rgba(26,86,219,0.2); color: var(--blue-300); border-left: 2px solid var(--blue-400); }
.nav-item .icon { font-size: 16px; width: 20px; text-align: center; }
.nav-badge {
  margin-left: auto;
  background: var(--blue-500);
  color: white;
  font-size: 10px;
  font-weight: 600;
  padding: 1px 6px;
  border-radius: 10px;
  font-family: 'DM Mono', monospace;
}
.sidebar-footer {
  margin-top: auto;
  padding: 12px 8px;
  border-top: 1px solid var(--card-border);
}

/* MAIN CONTENT */
.main {
  margin-left: var(--sidebar-w);
  min-height: 100vh;
  position: relative;
  z-index: 1;
}
.topbar {
  position: sticky;
  top: 0;
  background: rgba(5,13,26,0.92);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--card-border);
  padding: 0 28px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 90;
}
.page-title {
  font-family: 'Sora', sans-serif;
  font-size: 17px;
  font-weight: 600;
  color: var(--text-primary);
}
.topbar-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all 0.18s ease;
  font-family: 'DM Sans', sans-serif;
}
.btn-primary {
  background: var(--blue-500);
  color: white;
}
.btn-primary:hover { background: var(--blue-400); transform: translateY(-1px); }
.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--card-border);
}
.btn-ghost:hover { background: rgba(59,130,246,0.1); color: var(--text-primary); }

.content {
  padding: 24px 28px;
}

/* SECTION MANAGEMENT */
.section { display: none; }
.section.active { display: block; }

/* STAT CARDS */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: 14px;
  padding: 20px;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(26,86,219,0.15); }
.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--blue-500), var(--accent));
  opacity: 0.6;
}
.stat-icon {
  font-size: 24px;
  margin-bottom: 12px;
}
.stat-value {
  font-family: 'Sora', sans-serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1;
}
.stat-label {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
  letter-spacing: 0.02em;
}
.stat-change {
  font-size: 11px;
  color: var(--success);
  margin-top: 6px;
}

/* TABLES & CARDS */
.card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: 14px;
  backdrop-filter: blur(10px);
  overflow: hidden;
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--card-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-title {
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}
.card-body { padding: 0; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  padding: 10px 16px;
  text-align: left;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--text-muted);
  background: rgba(26,86,219,0.06);
  border-bottom: 1px solid var(--card-border);
}
.data-table td {
  padding: 12px 16px;
  font-size: 13px;
  color: var(--text-secondary);
  border-bottom: 1px solid rgba(59,130,246,0.06);
  transition: background 0.15s;
}
.data-table tr:hover td { background: rgba(59,130,246,0.05); }
.data-table tr:last-child td { border-bottom: none; }
.data-table .patient-name { color: var(--text-primary); font-weight: 500; }
.visit-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  background: rgba(14,165,233,0.15);
  border: 1px solid rgba(14,165,233,0.3);
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  font-family: 'DM Mono', monospace;
}
.status-pill {
  display: inline-block;
  padding: 3px 9px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 500;
}
.status-active { background: rgba(16,185,129,0.15); color: var(--success); }
.status-pending { background: rgba(245,158,11,0.15); color: var(--warning); }
.status-completed { background: rgba(59,130,246,0.15); color: var(--blue-300); }
.status-cancelled { background: rgba(239,68,68,0.15); color: var(--danger); }

.clickable-row { cursor: pointer; }
.action-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 13px;
  transition: all 0.15s;
}
.action-btn:hover { background: rgba(59,130,246,0.15); color: var(--blue-300); }

/* GRID LAYOUT */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.mb-4 { margin-bottom: 16px; }
.mb-6 { margin-bottom: 24px; }

/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(5,13,26,0.85);
  backdrop-filter: blur(4px);
  z-index: 200;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--navy-700);
  border: 1px solid var(--card-border);
  border-radius: 18px;
  width: 700px;
  max-width: 95vw;
  max-height: 88vh;
  overflow-y: auto;
  position: relative;
}
.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--card-border);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}
.modal-title {
  font-family: 'Sora', sans-serif;
  font-size: 16px;
  font-weight: 600;
}
.modal-close {
  background: none; border: none;
  color: var(--text-muted);
  font-size: 20px;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 6px;
}
.modal-close:hover { background: rgba(239,68,68,0.15); color: var(--danger); }
.modal-body { padding: 24px; }

/* TABS */
.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 1px solid var(--card-border);
  margin-bottom: 20px;
}
.tab-btn {
  padding: 8px 16px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
  transition: all 0.15s;
  font-family: 'DM Sans', sans-serif;
}
.tab-btn:hover { color: var(--text-primary); }
.tab-btn.active { color: var(--blue-300); border-bottom-color: var(--blue-400); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* DEMOGRAPHICS GRID */
.demo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.demo-field {
  background: rgba(26,86,219,0.06);
  border: 1px solid var(--card-border);
  border-radius: 8px;
  padding: 10px 14px;
}
.demo-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 3px; }
.demo-value { font-size: 13px; color: var(--text-primary); font-weight: 500; }

/* MEDICAL HISTORY TIMELINE */
.timeline { position: relative; }
.timeline::before {
  content: '';
  position: absolute;
  left: 18px; top: 0; bottom: 0;
  width: 2px;
  background: linear-gradient(180deg, var(--blue-500), transparent);
}
.timeline-item {
  display: flex;
  gap: 14px;
  margin-bottom: 18px;
  position: relative;
}
.timeline-dot {
  flex-shrink: 0;
  width: 38px; height: 38px;
  background: rgba(26,86,219,0.2);
  border: 2px solid var(--blue-400);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  z-index: 1;
}
.timeline-content {
  flex: 1;
  background: rgba(26,86,219,0.06);
  border: 1px solid var(--card-border);
  border-radius: 10px;
  padding: 12px 14px;
}
.timeline-date { font-size: 11px; color: var(--accent); font-family: 'DM Mono', monospace; margin-bottom: 4px; }
.timeline-title { font-size: 13px; font-weight: 600; color: var(--text-primary); }
.timeline-detail { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
.timeline-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.tag {
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 4px;
  background: rgba(59,130,246,0.12);
  border: 1px solid rgba(59,130,246,0.2);
  color: var(--blue-200);
}

/* LOADING */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 48px;
  color: var(--text-muted);
  font-size: 13px;
  gap: 8px;
}
.spinner {
  width: 16px; height: 16px;
  border: 2px solid var(--card-border);
  border-top-color: var(--blue-400);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* FORM */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group.full { grid-column: 1 / -1; }
.form-label { font-size: 11px; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-muted); }
.form-input, .form-select, .form-textarea {
  background: rgba(26,86,219,0.06);
  border: 1px solid var(--card-border);
  border-radius: 8px;
  padding: 9px 12px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: 'DM Sans', sans-serif;
  transition: border-color 0.15s;
  outline: none;
  width: 100%;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color: var(--blue-400);
  background: rgba(26,86,219,0.1);
}
.form-select option { background: var(--navy-700); }
.form-textarea { resize: vertical; min-height: 80px; }

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: var(--text-muted);
}
.empty-state .icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
.empty-state p { font-size: 13px; }

/* ALERTS */
.alert {
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 12px;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.alert-info { background: rgba(14,165,233,0.12); border: 1px solid rgba(14,165,233,0.25); color: var(--accent); }
.alert-success { background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.25); color: var(--success); }
.alert-error { background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.25); color: var(--danger); }

/* PRACTITIONER LINK */
.prac-link-box {
  background: rgba(245,158,11,0.08);
  border: 1px solid rgba(245,158,11,0.25);
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.prac-link-box .icon { font-size: 20px; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--steel); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--steel-light); }

/* RESPONSIVE */
@media(max-width: 900px) {
  :root { --sidebar-w: 0px; }
  .sidebar { transform: translateX(-260px); transition: transform 0.3s; }
  .main { margin-left: 0; }
  .stats-grid { grid-template-columns: repeat(2,1fr); }
}

/* ANIMATIONS */
@keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
.section.active { animation: fadeIn 0.3s ease; }

/* HR SECTION */
.hr-cards { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 20px; }
.hr-card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s;
}
.hr-card:hover { transform: translateY(-2px); border-color: var(--blue-400); }
.hr-card-icon { font-size: 24px; margin-bottom: 8px; }
.hr-card-title { font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 600; }
.hr-card-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-brand">
    <div class="brand-logo">üè•</div>
    <div class="brand-name">Rena Rehabilitation</div>
    <div class="brand-sub">Doctor Portal</div>
  </div>

  <div class="doctor-info" id="sidebarDoctorInfo">
    <div class="doctor-avatar">üë®‚Äç‚öïÔ∏è</div>
    <div class="doctor-name" id="sidebarDoctorName">Loading...</div>
    <div class="doctor-role">
      <span style="width:6px;height:6px;border-radius:50%;background:var(--success);display:inline-block;"></span>
      Practitioner
    </div>
  </div>

  <div class="nav-section">Clinical</div>
  <div class="nav-item active" onclick="showSection('dashboard')">
    <span class="icon">üìä</span> Dashboard
  </div>
  <div class="nav-item" onclick="showSection('patients')">
    <span class="icon">üë•</span> My Patients
    <span class="nav-badge" id="patientCountBadge">0</span>
  </div>
  <div class="nav-item" onclick="showSection('encounters')">
    <span class="icon">üìã</span> Encounters
  </div>
  <div class="nav-item" onclick="showSection('serviceReq')">
    <span class="icon">üî¨</span> Service Requests
  </div>
  <div class="nav-item" onclick="showSection('therapy')">
    <span class="icon">üß†</span> Therapy Plans
  </div>

  <div class="nav-section">Account</div>
  <div class="nav-item" onclick="showSection('profile')">
    <span class="icon">üë§</span> My Profile
  </div>

  <div class="nav-section">HR</div>
  <div class="nav-item" onclick="showSection('hr')">
    <span class="icon">üìÅ</span> HR Portal
  </div>

  <div class="sidebar-footer">
    <div class="nav-item" onclick="logout()" style="color:var(--danger);">
      <span class="icon">üö™</span> Logout
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="page-title" id="pageTitle">Dashboard</div>
    <div class="topbar-actions">
      <div id="topbarAlert"></div>
      <button class="btn btn-ghost" onclick="refreshCurrentSection()">‚Üª Refresh</button>
      <button class="btn btn-primary" onclick="showSection('encounters')">+ New Encounter</button>
    </div>
  </div>

  <div class="content">

    <!-- PRACTITIONER LINK SETUP -->
    <div id="pracLinkSetup" style="display:none;" class="mb-6">
      <div class="prac-link-box">
        <div class="icon">‚ö†Ô∏è</div>
        <div style="flex:1">
          <div style="font-weight:600; font-size:13px;">Link Your Practitioner Account</div>
          <div style="font-size:12px; color:var(--text-muted); margin-top:3px;">Select your practitioner profile to enable full dashboard features.</div>
        </div>
        <select class="form-select" id="pracLinkSelect" style="width:220px" onchange="linkPractitioner(this.value)">
          <option value="">‚Äî Select Practitioner ‚Äî</option>
        </select>
      </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="s_dashboard" class="section active">
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-value" id="statToday">‚Äî</div>
          <div class="stat-label">Today's Appointments</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-value" id="statCompleted">‚Äî</div>
          <div class="stat-label">Completed Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-value" id="statPatients">‚Äî</div>
          <div class="stat-label">Total Patients</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üî¨</div>
          <div class="stat-value" id="statServiceReq">‚Äî</div>
          <div class="stat-label">Pending Service Requests</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <span class="card-title">üìÖ Today's Appointments</span>
          </div>
          <div class="card-body">
            <table class="data-table">
              <thead><tr><th>Patient</th><th>Time</th><th>Status</th></tr></thead>
              <tbody id="todayAppTbody"><tr><td colspan="3"><div class="loading"><div class="spinner"></div> Loading...</div></td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">üî¨ Recent Service Requests</span>
            <button class="btn btn-ghost" style="font-size:12px;" onclick="showSection('serviceReq')">View All</button>
          </div>
          <div class="card-body">
            <table class="data-table">
              <thead><tr><th>Patient</th><th>Template Type</th><th>Referred By</th><th>Status</th></tr></thead>
              <tbody id="dashServiceReqTbody"><tr><td colspan="4"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- PATIENTS SECTION -->
    <div id="s_patients" class="section">
      <div class="mb-4" style="display:flex; justify-content:space-between; align-items:center;gap:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="font-size:13px; color:var(--text-muted);">Click a patient to view demographics & medical history</div>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;color:var(--text-secondary);">
            <input type="checkbox" id="myPatientsToggle" onchange="loadPatients(this.checked)" style="accent-color:var(--blue-400);">
            My patients only
          </label>
        </div>
        <input type="text" class="form-input" placeholder="üîç Search patients..." oninput="filterPatients(this.value)" style="width:240px;">
      </div>
      <div class="card">
        <div class="card-body">
          <table class="data-table">
            <thead>
              <tr>
                <th>Patient</th>
                <th>Gender</th>
                <th>DOB / Age</th>
                <th>Contact</th>
                <th>Visits</th>
                <th>Last Visit</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="patientsTbody"><tr><td colspan="7"><div class="loading"><div class="spinner"></div> Loading patients...</div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ENCOUNTERS SECTION -->
    <div id="s_encounters" class="section">
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìã Patient Encounters</span>
        </div>
        <div class="card-body">
          <table class="data-table">
            <thead><tr><th>Encounter ID</th><th>Patient</th><th>Date</th><th>Practitioner</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="encountersTbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SERVICE REQUESTS SECTION -->
    <div id="s_serviceReq" class="section">
      <div class="mb-4" style="display:flex; justify-content:flex-end;">
        <button class="btn btn-primary" onclick="openNewServiceReqModal()">+ New Service Request</button>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">üî¨ Service Requests</span></div>
        <div class="card-body">
          <table class="data-table">
            <thead><tr><th>ID</th><th>Patient</th><th>Template Type</th><th>Ordered By</th><th>Referred Practitioner</th><th>Status</th><th>Date</th></tr></thead>
            <tbody id="serviceReqTbody"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- THERAPY SECTION -->
    <div id="s_therapy" class="section">
      <div class="grid-2 mb-4">
        <div class="card">
          <div class="card-header"><span class="card-title">üß† Therapy Plans</span></div>
          <div class="card-body">
            <table class="data-table">
              <thead><tr><th>Plan</th><th>Patient</th><th>Start</th><th>Sessions</th><th>Status</th></tr></thead>
              <tbody id="therapyPlansTbody"><tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">üìù Therapy Sessions</span></div>
          <div class="card-body">
            <table class="data-table">
              <thead><tr><th>Session</th><th>Patient</th><th>Date</th><th>Status</th></tr></thead>
              <tbody id="therapySessionsTbody"><tr><td colspan="4"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE SECTION -->
    <div id="s_profile" class="section">
      <div class="card">
        <div class="card-header"><span class="card-title">üë§ My Profile</span></div>
        <div class="card-body" id="profileBody">
          <div class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>
      <div class="card" style="margin-top:14px;">
        <div class="card-header"><span class="card-title">üîó Practitioner Link</span></div>
        <div class="card-body">
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">If your practitioner profile isn't auto-detected, select it manually:</p>
          <select class="form-select" id="profilePracSelect" style="max-width:320px;" onchange="linkPractitioner(this.value)">
            <option value="">‚Äî Select Practitioner ‚Äî</option>
          </select>
          <div id="profileLinkStatus" style="margin-top:8px;font-size:12px;color:var(--success);"></div>
        </div>
      </div>
    </div>

    <!-- HR SECTION -->
    <div id="s_hr" class="section">
      <div class="hr-cards">
        <div class="hr-card" onclick="loadAttendance()">
          <div class="hr-card-icon">üïê</div>
          <div class="hr-card-title">Attendance</div>
          <div class="hr-card-sub">Check in / check out records</div>
        </div>
        <div class="hr-card" onclick="loadLeave()">
          <div class="hr-card-icon">üå¥</div>
          <div class="hr-card-title">Leave</div>
          <div class="hr-card-sub">Leave balance & applications</div>
        </div>
        <div class="hr-card" onclick="loadPayroll()">
          <div class="hr-card-icon">üí∞</div>
          <div class="hr-card-title">Payroll</div>
          <div class="hr-card-sub">Salary slips & history</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title" id="hrCardTitle">Select a section above</span></div>
        <div class="card-body" id="hrCardBody">
          <div class="empty-state"><div class="icon">üìÅ</div><p>Select Attendance, Leave, or Payroll</p></div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>

<!-- PATIENT DETAIL MODAL -->
<div class="modal-overlay" id="patientModal">
  <div class="modal" style="width:750px;">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="patientModalTitle">Patient Details</div>
        <div style="font-size:12px; color:var(--text-muted); margin-top:3px;" id="patientModalSub"></div>
      </div>
      <button class="modal-close" onclick="closeModal('patientModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this,'ptDemos')">Demographics</button>
        <button class="tab-btn" onclick="switchTab(this,'ptHistory')">Medical History</button>
        <button class="tab-btn" onclick="switchTab(this,'ptReports')">Reports & Files</button>
      </div>

      <div id="ptDemos" class="tab-panel active">
        <div class="demo-grid" id="demoGrid">
          <div class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>

      <div id="ptHistory" class="tab-panel">
        <div id="historyTimeline">
          <div class="loading"><div class="spinner"></div> Loading history...</div>
        </div>
      </div>

      <div id="ptReports" class="tab-panel">
        <div id="reportsPanel">
          <div class="loading"><div class="spinner"></div> Loading reports...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SERVICE REQUEST MODAL -->
<div class="modal-overlay" id="serviceReqModal">
  <div class="modal" style="width:580px;">
    <div class="modal-header">
      <div class="modal-title">New Service Request</div>
      <button class="modal-close" onclick="closeModal('serviceReqModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="srAlertArea"></div>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Patient *</label>
          <input class="form-input" id="srPatient" placeholder="Patient name/ID">
        </div>
        <div class="form-group">
          <label class="form-label">Order Template Type *</label>
          <select class="form-select" id="srTemplateType">
            <option value="">‚Äî Select ‚Äî</option>
            <option>Lab Test</option>
            <option>Radiology</option>
            <option>Clinical Procedure</option>
            <option>Therapy</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Ordered By Practitioner</label>
          <input class="form-input" id="srOrderedBy" readonly style="cursor:not-allowed; opacity:0.7;">
        </div>
        <div class="form-group">
          <label class="form-label">Referred Practitioner</label>
          <input class="form-input" id="srReferredBy" placeholder="Referred by...">
        </div>
        <div class="form-group full">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="srNotes" placeholder="Clinical notes..."></textarea>
        </div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
        <button class="btn btn-ghost" onclick="closeModal('serviceReqModal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitServiceRequest()">Submit Request</button>
      </div>
    </div>
  </div>
</div>

<script>
const BASE = '';
let currentUser = null;
let practitionerName = null;
let practitionerDoc = null;
let employeeName = null;
let allPatients = [];

async function api(method, args={}) {
  const res = await fetch(`${BASE}/api/method/${method}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-Frappe-CSRF-Token': getCsrf() },
    body: JSON.stringify(args)
  });
  const data = await res.json();
  if (data.exc) throw new Error(data.exc);
  return data.message ?? data;
}

async function getDoc(doctype, name) {
  const res = await fetch(`${BASE}/api/resource/${encodeURIComponent(doctype)}/${encodeURIComponent(name)}`);
  const d = await res.json();
  return d.data;
}

async function getList(doctype, fields=['name'], filters=[], limit=50, orderBy='modified desc') {
  const params = new URLSearchParams({
    doctype,
    fields: JSON.stringify(fields),
    filters: JSON.stringify(filters),
    limit_page_length: limit,
    order_by: orderBy
  });
  const res = await fetch(`${BASE}/api/resource/${encodeURIComponent(doctype)}?${params}`, { headers: { 'X-Frappe-CSRF-Token': getCsrf() } });
  const d = await res.json();
  return d.data || [];
}

function getCsrf() {
  if (typeof frappe !== 'undefined' && frappe.csrf_token) return frappe.csrf_token;
  return (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';
}

async function init() {
  // Auth check
  try {
    const whoami = await api('frappe.auth.get_logged_user');
    currentUser = typeof whoami === 'string' ? whoami : whoami?.message;
    if (!currentUser || currentUser === 'Guest') {
      window.location.replace('/login');
      return;
    }
    document.getElementById('sidebarDoctorName').textContent = currentUser || 'Doctor';
  } catch(e) {
    window.location.replace('/login');
    return;
  }

  // Try to auto-find practitioner linked to current user
  try {
    const prac = await getList('Healthcare Practitioner', ['name','practitioner_name','employee','department'], [['user_id','=',currentUser]], 1);
    if (prac.length) {
      practitionerName = prac[0].name;
      practitionerDoc = prac[0];
      employeeName = prac[0].employee;
      localStorage.setItem('rrc_practitioner', practitionerName);
      document.getElementById('sidebarDoctorName').textContent = prac[0].practitioner_name || currentUser;
      document.getElementById('pracLinkSetup').style.display = 'none';
    } else {
      // Fallback to saved or manual link
      const saved = localStorage.getItem('rrc_practitioner');
      if (saved) {
        practitionerName = saved;
        await loadPractitionerInfo();
      } else {
        await offerPractitionerLink();
      }
    }
  } catch(e) {
    const saved = localStorage.getItem('rrc_practitioner');
    if (saved) { practitionerName = saved; await loadPractitionerInfo(); }
    else await offerPractitionerLink();
  }

  loadDashboard();
}

async function loadPractitionerInfo() {
  try {
    const p = await getDoc('Healthcare Practitioner', practitionerName);
    practitionerDoc = p;
    document.getElementById('sidebarDoctorName').textContent = p.practitioner_name || practitionerName;
    document.getElementById('pracLinkSetup').style.display = 'none';
    // also link employee
    if (p.employee) employeeName = p.employee;
  } catch(e) {}
}

async function offerPractitionerLink() {
  try {
    const list = await getList('Healthcare Practitioner', ['name','practitioner_name','department'], [], 100);
    if (!list.length) return;
    const sel = document.getElementById('pracLinkSelect');
    list.forEach(p => {
      const o = document.createElement('option');
      o.value = p.name;
      o.textContent = `${p.practitioner_name} (${p.name})`;
      sel.appendChild(o);
    });
    document.getElementById('pracLinkSetup').style.display = 'block';
  } catch(e) {}
}

function linkPractitioner(val) {
  if (!val) return;
  practitionerName = val;
  localStorage.setItem('rrc_practitioner', val);
  document.getElementById('profileLinkStatus').textContent = '‚úì Practitioner linked: ' + val;
  loadPractitionerInfo();
  loadDashboard();
}

// ‚îÄ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProfile() {
  const el = document.getElementById('profileBody');
  el.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  try {
    const rows = [];
    rows.push(['üë§ Logged in as', currentUser || '‚Äî']);
    if (practitionerDoc) {
      rows.push(['ü©∫ Practitioner ID', practitionerDoc.name || '‚Äî']);
      rows.push(['üìõ Name', practitionerDoc.practitioner_name || '‚Äî']);
      rows.push(['üè• Department', practitionerDoc.department || '‚Äî']);
      rows.push(['üë§ Gender', practitionerDoc.gender || '‚Äî']);
      rows.push(['üìû Mobile', practitionerDoc.mobile || '‚Äî']);
      rows.push(['‚úâ Email', practitionerDoc.email || currentUser || '‚Äî']);
      if (practitionerDoc.employee) rows.push(['üÜî Employee', practitionerDoc.employee]);
    } else {
      rows.push(['‚ö† Status', 'Practitioner profile not linked']);
    }
    el.innerHTML = `<table class="data-table"><tbody>${rows.map(r=>`<tr>
      <td style="font-size:12px;color:var(--text-muted);width:160px;">${r[0]}</td>
      <td style="font-size:13px;font-weight:500;">${r[1]}</td>
    </tr>`).join('')}</tbody></table>`;
    // Also populate profile prac select
    try {
      const list = await getList('Healthcare Practitioner',['name','practitioner_name'],[],100);
      const sel = document.getElementById('profilePracSelect');
      sel.innerHTML = '<option value="">‚Äî Select Practitioner ‚Äî</option>';
      list.forEach(p => { const o=document.createElement('option');o.value=p.name;o.textContent=`${p.practitioner_name||p.name} (${p.name})`;sel.appendChild(o); });
      if (practitionerName) sel.value = practitionerName;
    } catch(e) {}
  } catch(e) { el.innerHTML = `<div class="alert alert-error">‚ö† ${e.message}</div>`; }
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('s_' + id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  event?.currentTarget?.classList.add('active');

  const titles = {
    dashboard: 'Dashboard', patients: 'My Patients', encounters: 'Patient Encounters',
    serviceReq: 'Service Requests', therapy: 'Therapy', hr: 'HR Portal', profile: 'My Profile'
  };
  document.getElementById('pageTitle').textContent = titles[id] || id;

  const loaders = {
    patients: loadPatients, encounters: loadEncounters,
    serviceReq: loadServiceRequests, therapy: loadTherapy, profile: loadProfile
  };
  if (loaders[id]) loaders[id]();
}

function refreshCurrentSection() {
  const active = document.querySelector('.section.active');
  if (!active) return;
  const id = active.id.replace('s_','');
  const loaders = {
    dashboard: loadDashboard, patients: loadPatients, encounters: loadEncounters,
    serviceReq: loadServiceRequests, therapy: loadTherapy
  };
  if (loaders[id]) loaders[id]();
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  loadTodayAppointments();
  loadDashServiceRequests();
  loadStats();
}

async function loadStats() {
  try {
    const today = new Date().toISOString().split('T')[0];
    const [appts, patients, serviceReqs] = await Promise.all([
      getList('Patient Appointment', ['name','status'], practitionerName ? [['practitioner','=',practitionerName],['appointment_date','=',today]] : [['appointment_date','=',today]], 200),
      getList('Patient', ['name'], [], 500),
      getList('Service Request', ['name','status'], [['status','in',['Pending','Draft']]], 200)
    ]);
    document.getElementById('statToday').textContent = appts.length;
    document.getElementById('statCompleted').textContent = appts.filter(a=>a.status==='Closed').length;
    document.getElementById('statPatients').textContent = patients.length;
    document.getElementById('statServiceReq').textContent = serviceReqs.length;
    document.getElementById('patientCountBadge').textContent = patients.length;
  } catch(e) {}
}

async function loadTodayAppointments() {
  const tbody = document.getElementById('todayAppTbody');
  try {
    const today = new Date().toISOString().split('T')[0];
    const filters = [['appointment_date','=',today]];
    if (practitionerName) filters.push(['practitioner','=',practitionerName]);
    const appts = await getList('Patient Appointment',
      ['name','patient_name','appointment_time','status','patient'], filters, 30);
    if (!appts.length) { tbody.innerHTML = `<tr><td colspan="3"><div class="empty-state"><div class="icon">üìÖ</div><p>No appointments today</p></div></td></tr>`; return; }
    tbody.innerHTML = appts.map(a => `
      <tr>
        <td class="patient-name">${a.patient_name}</td>
        <td style="font-family:'DM Mono',monospace; font-size:12px;">${a.appointment_time || '‚Äî'}</td>
        <td><span class="status-pill ${statusClass(a.status)}">${a.status}</span></td>
      </tr>`).join('');
  } catch(e) { tbody.innerHTML = errRow(3, e); }
}

async function loadDashServiceRequests() {
  const tbody = document.getElementById('dashServiceReqTbody');
  try {
    const filters = practitionerName ? [['ordered_by','=',practitionerName]] : [];
    const reqs = await getList('Service Request',
      ['name','patient','template_dt','ordered_by','referred_to','status'], filters, 10);
    if (!reqs.length) { tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state"><p>No service requests</p></div></td></tr>`; return; }
    tbody.innerHTML = reqs.map(r => `
      <tr>
        <td class="patient-name">${r.patient || '‚Äî'}</td>
        <td><span class="tag">${r.template_dt||'‚Äî'}</span></td>
        <td>${r.referred_to || r.ordered_by || '‚Äî'}</td>
        <td><span class="status-pill ${statusClass(r.status)}">${r.status||'‚Äî'}</span></td>
      </tr>`).join('');
  } catch(e) { tbody.innerHTML = errRow(4, e); }
}

// ‚îÄ‚îÄ‚îÄ PATIENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadPatients(myPatientsOnly) {
  const tbody = document.getElementById('patientsTbody');
  tbody.innerHTML = `<tr><td colspan="7"><div class="loading"><div class="spinner"></div> Loading...</div></td></tr>`;
  try {
    // Show ALL patients by default; if myPatientsOnly flag, filter by practitioner via encounters
    const patients = await getList('Patient',
      ['name','patient_name','sex','dob','mobile','patient_age','status'], [], 500, 'patient_name asc');

    // Get encounter counts
    const encounterCounts = {};
    try {
      const encFilters = practitionerName && myPatientsOnly ? [['practitioner','=',practitionerName]] : [];
      const encounters = await getList('Patient Encounter', ['name','patient'], encFilters, 5000);
      encounters.forEach(e => { encounterCounts[e.patient] = (encounterCounts[e.patient]||0)+1; });
    } catch(e) {}

    let list = patients.map(p => ({ ...p, visitCount: encounterCounts[p.name] || 0 }));
    if (myPatientsOnly && practitionerName) {
      // filter to only patients who have encounters with this practitioner
      list = list.filter(p => p.visitCount > 0);
    }

    allPatients = list;
    document.getElementById('patientCountBadge').textContent = list.length;
    renderPatients(list);
  } catch(e) { tbody.innerHTML = errRow(7, e.message || e); }
}

function renderPatients(list) {
  const tbody = document.getElementById('patientsTbody');
  if (!list.length) { tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="icon">üë•</div><p>No patients found</p></div></td></tr>`; return; }
  tbody.innerHTML = list.map(p => `
    <tr class="clickable-row" onclick="openPatientModal('${p.name}','${escapeJs(p.patient_name)}',${p.visitCount})">
      <td class="patient-name">${p.patient_name}</td>
      <td>${p.sex||'‚Äî'}</td>
      <td style="font-family:'DM Mono',monospace; font-size:12px;">${p.dob||p.patient_age||'‚Äî'}</td>
      <td>${p.mobile||'‚Äî'}</td>
      <td><span class="visit-badge">üè• ${p.visitCount}</span></td>
      <td id="lastVisit_${p.name}" style="font-size:12px; color:var(--text-muted);">‚Äî</td>
      <td>
        <button class="action-btn" onclick="event.stopPropagation(); openPatientModal('${p.name}','${escapeJs(p.patient_name)}',${p.visitCount})">üëÅ View</button>
      </td>
    </tr>`).join('');

  // Async load last visit dates
  list.forEach(async p => {
    try {
      const enc = await getList('Patient Encounter', ['encounter_date'], [['patient','=',p.name]], 1, 'encounter_date desc');
      if (enc.length) document.getElementById(`lastVisit_${p.name}`).textContent = enc[0].encounter_date;
    } catch(e){}
  });
}

function filterPatients(q) {
  if (!q) { renderPatients(allPatients); return; }
  const lower = q.toLowerCase();
  renderPatients(allPatients.filter(p =>
    (p.patient_name||'').toLowerCase().includes(lower) ||
    (p.mobile||'').includes(q) ||
    p.name.toLowerCase().includes(lower)
  ));
}

// ‚îÄ‚îÄ‚îÄ PATIENT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openPatientModal(patientId, patientName, visitCount) {
  document.getElementById('patientModalTitle').textContent = patientName;
  document.getElementById('patientModalSub').textContent = `${visitCount} visit${visitCount!==1?'s':''} recorded ¬∑ ID: ${patientId}`;
  document.getElementById('patientModal').classList.add('open');

  // Reset tabs
  document.querySelectorAll('#patientModal .tab-btn').forEach((b,i) => b.classList.toggle('active',i===0));
  document.querySelectorAll('#patientModal .tab-panel').forEach((p,i) => p.classList.toggle('active',i===0));

  // Load demographics
  loadPatientDemographics(patientId);
  // Pre-load history
  loadPatientHistory(patientId);
  loadPatientReports(patientId);
}

async function loadPatientDemographics(patientId) {
  const grid = document.getElementById('demoGrid');
  grid.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  try {
    const p = await getDoc('Patient', patientId);
    const fields = [
      { label: 'Full Name', value: p.patient_name },
      { label: 'Patient ID', value: p.name },
      { label: 'Gender', value: p.sex },
      { label: 'Date of Birth', value: p.dob || '‚Äî' },
      { label: 'Age', value: p.patient_age || '‚Äî' },
      { label: 'Blood Group', value: p.blood_group || '‚Äî' },
      { label: 'Mobile', value: p.mobile || '‚Äî' },
      { label: 'Email', value: p.email || '‚Äî' },
      { label: 'Address', value: [p.address_line1, p.city, p.state, p.pincode].filter(Boolean).join(', ') || '‚Äî' },
      { label: 'Emergency Contact', value: p.emergency_phone || '‚Äî' },
      { label: 'Insurance', value: p.health_insurance_id || '‚Äî' },
      { label: 'Status', value: p.status || 'Active' },
    ];
    grid.innerHTML = fields.map(f => `
      <div class="demo-field">
        <div class="demo-label">${f.label}</div>
        <div class="demo-value">${f.value}</div>
      </div>`).join('');
  } catch(e) { grid.innerHTML = `<div class="alert alert-error">‚ö† Could not load demographics</div>`; }
}

async function loadPatientHistory(patientId) {
  const timeline = document.getElementById('historyTimeline');
  timeline.innerHTML = `<div class="loading"><div class="spinner"></div> Loading medical history...</div>`;
  try {
    const encounters = await getList('Patient Encounter',
      ['name','encounter_date','practitioner','diagnosis','symptoms','encounter_type'],
      [['patient','=',patientId]], 50, 'encounter_date desc');

    if (!encounters.length) {
      timeline.innerHTML = `<div class="empty-state"><div class="icon">üìã</div><p>No previous encounters on record</p></div>`;
      return;
    }

    const icons = { 'OPD': 'ü©∫', 'IPD': 'üè•', 'Emergency': 'üö®', default: 'üìã' };
    const items = encounters.map(e => {
      const icon = icons[e.encounter_type] || icons.default;
      return `
        <div class="timeline-item">
          <div class="timeline-dot">${icon}</div>
          <div class="timeline-content">
            <div class="timeline-date">${e.encounter_date} ¬∑ ${e.encounter_type||'Consultation'}</div>
            <div class="timeline-title">${e.name}</div>
            ${e.practitioner ? `<div class="timeline-detail">üë®‚Äç‚öïÔ∏è Dr. ${e.practitioner}</div>` : ''}
            ${e.diagnosis ? `<div class="timeline-detail">Dx: ${e.diagnosis}</div>` : ''}
            ${e.symptoms ? `<div class="timeline-tags">${e.symptoms.split(',').map(s=>`<span class="tag">${s.trim()}</span>`).join('')}</div>` : ''}
          </div>
        </div>`;
    }).join('');
    timeline.innerHTML = `<div class="timeline">${items}</div>`;
  } catch(e) { timeline.innerHTML = `<div class="alert alert-error">‚ö† Could not load history</div>`; }
}

async function loadPatientReports(patientId) {
  const panel = document.getElementById('reportsPanel');
  panel.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  try {
    // Try to get attached files
    const files = await getList('File', ['name','file_name','file_url','modified'],
      [['attached_to_doctype','=','Patient'],['attached_to_name','=',patientId]], 50);

    if (!files.length) {
      panel.innerHTML = `<div class="empty-state"><div class="icon">üìÇ</div><p>No uploaded reports found</p></div>`;
      return;
    }
    panel.innerHTML = `<table class="data-table">
      <thead><tr><th>File Name</th><th>Uploaded</th><th>Action</th></tr></thead>
      <tbody>${files.map(f => `
        <tr>
          <td class="patient-name">üìé ${f.file_name || f.name}</td>
          <td style="font-size:12px;color:var(--text-muted);">${(f.modified||'').substring(0,10)}</td>
          <td><a href="${f.file_url}" target="_blank" class="btn btn-ghost" style="font-size:12px; padding:4px 10px;">Open</a></td>
        </tr>`).join('')}</tbody>
    </table>`;
  } catch(e) { panel.innerHTML = `<div class="alert alert-error">‚ö† Could not load files</div>`; }
}

// ‚îÄ‚îÄ‚îÄ ENCOUNTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadEncounters() {
  const tbody = document.getElementById('encountersTbody');
  try {
    const filters = practitionerName ? [['practitioner','=',practitionerName]] : [];
    const list = await getList('Patient Encounter',
      ['name','patient_name','encounter_date','practitioner','appointment_type','status'],
      filters, 100);
    if (!list.length) { tbody.innerHTML = emptyRow(6,'No encounters found'); return; }
    tbody.innerHTML = list.map(e => `
      <tr>
        <td class="patient-name" style="font-family:'DM Mono',monospace; font-size:12px;">${e.name}</td>
        <td>${e.patient_name||'‚Äî'}</td>
        <td>${e.encounter_date||'‚Äî'}</td>
        <td>${e.practitioner||'‚Äî'}</td>
        <td><span class="status-pill ${statusClass(e.status)}">${e.status||'Open'}</span></td>
        <td><a href="/healthcare/patient-encounter/${e.name}" target="_blank" class="action-btn">Open ‚Üó</a></td>
      </tr>`).join('');
  } catch(e) { tbody.innerHTML = errRow(6, e); }
}

// ‚îÄ‚îÄ‚îÄ SERVICE REQUESTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadServiceRequests() {
  const tbody = document.getElementById('serviceReqTbody');
  try {
    const filters = practitionerName ? [['ordered_by','=',practitionerName]] : [];
    const list = await getList('Service Request',
      ['name','patient','template_dt','ordered_by','referred_to','status','transaction_date'],
      filters, 100);
    if (!list.length) { tbody.innerHTML = emptyRow(7,'No service requests'); return; }
    tbody.innerHTML = list.map(r => `
      <tr>
        <td class="patient-name" style="font-family:'DM Mono',monospace; font-size:12px;">${r.name}</td>
        <td>${r.patient||'‚Äî'}</td>
        <td><span class="tag">${r.template_dt||'‚Äî'}</span></td>
        <td>${r.ordered_by||'‚Äî'}</td>
        <td>${r.referred_to||'‚Äî'}</td>
        <td><span class="status-pill ${statusClass(r.status)}">${r.status||'‚Äî'}</span></td>
        <td style="font-size:12px;">${(r.transaction_date||'').substring(0,10)}</td>
      </tr>`).join('');
  } catch(e) { tbody.innerHTML = errRow(7, e); }
}

function openNewServiceReqModal() {
  document.getElementById('srOrderedBy').value = practitionerDoc?.practitioner_name || practitionerName || '';
  document.getElementById('srAlertArea').innerHTML = '';
  document.getElementById('serviceReqModal').classList.add('open');
}

async function submitServiceRequest() {
  const patient = document.getElementById('srPatient').value.trim();
  const templateType = document.getElementById('srTemplateType').value;
  const alertArea = document.getElementById('srAlertArea');
  if (!patient) { alertArea.innerHTML = `<div class="alert alert-error">‚ö† Patient is required</div>`; return; }
  if (!templateType) { alertArea.innerHTML = `<div class="alert alert-error">‚ö† Template type is required</div>`; return; }
  try {
    await api('frappe.client.insert', {
      doc: {
        doctype: 'Service Request',
        patient,
        template_dt: templateType,
        ordered_by: practitionerName,
        notes: document.getElementById('srNotes').value
      }
    });
    alertArea.innerHTML = `<div class="alert alert-success">‚úì Service request created successfully</div>`;
    setTimeout(() => closeModal('serviceReqModal'), 1500);
    loadServiceRequests();
    loadDashServiceRequests();
  } catch(e) { alertArea.innerHTML = `<div class="alert alert-error">‚ö† Error: ${e.message}</div>`; }
}

// ‚îÄ‚îÄ‚îÄ THERAPY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadTherapy() {
  loadTherapyPlans();
  loadTherapySessions();
}

async function loadTherapyPlans() {
  const tbody = document.getElementById('therapyPlansTbody');
  try {
    const filters = practitionerName ? [['owner','=',currentUser]] : [];
    const list = await getList('Therapy Plan',
      ['name','patient','start_date','total_sessions','status'], [], 50);
    if (!list.length) { tbody.innerHTML = emptyRow(5,'No therapy plans'); return; }
    tbody.innerHTML = list.map(t => `
      <tr>
        <td class="patient-name" style="font-family:'DM Mono',monospace; font-size:12px;">${t.name}</td>
        <td>${t.patient||'‚Äî'}</td>
        <td>${t.start_date||'‚Äî'}</td>
        <td style="font-family:'DM Mono',monospace;">${t.total_sessions||0}</td>
        <td><span class="status-pill ${statusClass(t.status)}">${t.status||'Active'}</span></td>
      </tr>`).join('');
  } catch(e) { tbody.innerHTML = errRow(5, e); }
}

async function loadTherapySessions() {
  const tbody = document.getElementById('therapySessionsTbody');
  try {
    const list = await getList('Therapy Session',
      ['name','patient','start','custom_session_status'], [], 50);
    if (!list.length) { tbody.innerHTML = emptyRow(4,'No therapy sessions'); return; }
    tbody.innerHTML = list.map(s => `
      <tr>
        <td class="patient-name" style="font-family:'DM Mono',monospace; font-size:12px;">${s.name}</td>
        <td>${s.patient||'‚Äî'}</td>
        <td>${(s.start||'').substring(0,10)}</td>
        <td><span class="status-pill ${statusClass(s.custom_session_status)}">${s.custom_session_status||'Scheduled'}</span></td>
      </tr>`).join('');
  } catch(e) { tbody.innerHTML = errRow(4, e); }
}

// ‚îÄ‚îÄ‚îÄ HR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAttendance() {
  document.getElementById('hrCardTitle').textContent = 'üïê Attendance Records';
  document.getElementById('hrCardBody').innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  try {
    const filters = employeeName ? [['employee','=',employeeName]] : [];
    const list = await getList('Attendance', ['name','attendance_date','status','in_time','out_time'], filters, 30, 'attendance_date desc');
    if (!list.length) { document.getElementById('hrCardBody').innerHTML = emptyState('No attendance records found'); return; }
    document.getElementById('hrCardBody').innerHTML = `<table class="data-table">
      <thead><tr><th>Date</th><th>Status</th><th>In Time</th><th>Out Time</th></tr></thead>
      <tbody>${list.map(a=>`<tr>
        <td>${a.attendance_date}</td>
        <td><span class="status-pill ${statusClass(a.status)}">${a.status}</span></td>
        <td style="font-family:'DM Mono',monospace; font-size:12px;">${a.in_time||'‚Äî'}</td>
        <td style="font-family:'DM Mono',monospace; font-size:12px;">${a.out_time||'‚Äî'}</td>
      </tr>`).join('')}</tbody></table>`;
  } catch(e) { document.getElementById('hrCardBody').innerHTML = `<div class="alert alert-error">‚ö† Could not load attendance</div>`; }
}

async function loadLeave() {
  document.getElementById('hrCardTitle').textContent = 'üå¥ Leave Applications';
  document.getElementById('hrCardBody').innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  try {
    const filters = employeeName ? [['employee','=',employeeName]] : [];
    const list = await getList('Leave Application', ['name','leave_type','from_date','to_date','status'], filters, 30, 'from_date desc');
    if (!list.length) { document.getElementById('hrCardBody').innerHTML = emptyState('No leave applications'); return; }
    document.getElementById('hrCardBody').innerHTML = `<table class="data-table">
      <thead><tr><th>Type</th><th>From</th><th>To</th><th>Status</th></tr></thead>
      <tbody>${list.map(l=>`<tr>
        <td>${l.leave_type||'‚Äî'}</td>
        <td>${l.from_date}</td><td>${l.to_date}</td>
        <td><span class="status-pill ${statusClass(l.status)}">${l.status}</span></td>
      </tr>`).join('')}</tbody></table>`;
  } catch(e) { document.getElementById('hrCardBody').innerHTML = `<div class="alert alert-error">‚ö† Could not load leave</div>`; }
}

async function loadPayroll() {
  document.getElementById('hrCardTitle').textContent = 'üí∞ Salary Slips';
  document.getElementById('hrCardBody').innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
  try {
    const filters = employeeName ? [['employee','=',employeeName]] : [];
    const list = await getList('Salary Slip', ['name','start_date','end_date','net_pay','status'], filters, 24, 'start_date desc');
    if (!list.length) { document.getElementById('hrCardBody').innerHTML = emptyState('No salary slips'); return; }
    document.getElementById('hrCardBody').innerHTML = `<table class="data-table">
      <thead><tr><th>Period</th><th>Net Pay</th><th>Status</th><th>Action</th></tr></thead>
      <tbody>${list.map(s=>`<tr>
        <td>${s.start_date} ‚Üí ${s.end_date}</td>
        <td style="font-family:'DM Mono',monospace;">‚Çπ${Number(s.net_pay||0).toLocaleString()}</td>
        <td><span class="status-pill ${statusClass(s.status)}">${s.status}</span></td>
        <td><a href="/printview?doctype=Salary+Slip&name=${s.name}&format=Standard" target="_blank" class="action-btn">Print</a></td>
      </tr>`).join('')}</tbody></table>`;
  } catch(e) { document.getElementById('hrCardBody').innerHTML = `<div class="alert alert-error">‚ö† Could not load payroll</div>`; }
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(btn, panelId) {
  const modal = btn.closest('.modal-body') || btn.closest('.content');
  modal?.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  modal?.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(panelId)?.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m =>
  m.addEventListener('click', e => { if(e.target===m) m.classList.remove('open'); })
);

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function statusClass(s) {
  s = (s||'').toLowerCase();
  if (['active','open','scheduled','completed','closed','submitted'].some(v=>s.includes(v))) {
    if (s.includes('complet') || s.includes('closed') || s.includes('submit')) return 'status-completed';
    if (s.includes('active') || s.includes('open') || s.includes('present')) return 'status-active';
  }
  if (['pending','draft'].some(v=>s.includes(v))) return 'status-pending';
  if (['cancel','inactive'].some(v=>s.includes(v))) return 'status-cancelled';
  return 'status-active';
}
function errRow(cols, e) { return `<tr><td colspan="${cols}"><div class="alert alert-error">‚ö† ${e.message||'Error loading data'}</div></td></tr>`; }
function emptyRow(cols, msg) { return `<tr><td colspan="${cols}"><div class="empty-state"><div class="icon">üì≠</div><p>${msg}</p></div></td></tr>`; }
function emptyState(msg) { return `<div class="empty-state"><div class="icon">üì≠</div><p>${msg}</p></div>`; }
function escapeJs(s) { return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

async function logout() {
  try {
    await fetch(`${BASE}/api/method/frappe.auth.logout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Frappe-CSRF-Token': getCsrf() },
      body: JSON.stringify({})
    });
  } catch(e) {}
  localStorage.clear();
  window.location.replace('/login');
}

init();
</script>
</body>
</html>
